<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Vocabulary Match Game - Enhanced Version" />
  <title>Vocabulary Match Game</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&family=Poppins&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Touch Drag Support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dragdroptouch/0.3.0/DragDropTouch.min.js"></script>

  <!-- Confetti library -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --primary: #7f9ccb;
      --secondary: #ffd18d;
      --correct: #a8e6cf;
      --incorrect: #ff8a80;
      --neutral: #ccd4e0;
      --bg-light: #fefefe;
      --bg-dark: #1e1e1e;
      --text-light: #222;
      --text-dark: #eee;
      --progress-start: #7f9ccb;
      --progress-end: #60d394;
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-light);
      color: var(--text-light);
      background-image: radial-gradient(#ccc 1px, transparent 1px);
      background-size: 20px 20px;
      transition: background-color 0.5s ease, color 0.5s ease, background-image 0.5s ease;
    }

    body.dark {
      background-color: var(--bg-dark);
      color: var(--text-dark);
      background-image: radial-gradient(#444 1px, transparent 1px);
    }

    h1.title {
      font-family: 'Baloo 2', cursive;
      font-size: 3em;
      text-align: center;
      margin-top: 30px;
      animation: fadeIn 1s ease-in;
    }

    .lesson-btn {
      background: var(--secondary);
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .lesson-btn:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }

    .draggable, .droppable {
      background: linear-gradient(to bottom, #ffffff, #f0f4ff);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      font-size: 1.1em;
      transition: all 0.2s ease;
    }

    .droppable.matched::after {
      content: "✨";
      position: absolute;
      font-size: 1.2em;
      top: -8px;
      right: -8px;
      animation: sparkle 1s ease forwards;
    }

    @keyframes sparkle {
      0% { opacity: 0; transform: scale(0.5) rotate(0deg); }
      50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
      100% { opacity: 0; transform: scale(0.5) rotate(360deg); }
    }

    #progress-bar {
      background: linear-gradient(to right, var(--progress-start), var(--progress-end));
      height: 100%;
      transition: width 0.3s ease;
    }

    #dark-toggle {
      border: 2px solid var(--neutral);
      background: none;
      border-radius: 20px;
      padding: 8px 16px;
      transition: background 0.3s ease;
    }

    #dark-toggle:hover {
      background: var(--neutral);
    }

    #leaderboard, #stats-modal {
      background: var(--bg-light);
      color: var(--text-light);
      border-radius: 10px;
      padding: 20px;
      max-width: 500px;
      margin: 20px auto;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      display: none;
    }

    body.dark #leaderboard,
    body.dark #stats-modal {
      background: #2e2e2e;
      color: var(--text-dark);
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
<!-- The rest of the body including game UI, scripts, leaderboard, and confetti will be included in the next block -->
<!-- Title -->
<h1 class="title">Vocabulary Match Game</h1>

<!-- Scoreboard -->
<div class="scoreboard">
  🏆 Best Score: <span id="best-score">0</span> |
  🔥 Best Streak: <span id="best-streak">0</span>
</div>

<!-- Lesson Selection -->
<div id="lesson-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin: 20px auto; max-width: 650px; width: 90vw;"></div>

<!-- Dark Mode Toggle -->
<div style="text-align: center; margin: 20px;">
  <button id="dark-toggle">🌓 Toggle Dark Mode</button>
</div>

<!-- Game Screen -->
<div id="game-screen" style="display: none; flex-direction: column; align-items: center; padding: 20px; max-width: 1100px; margin: auto;">
  <div id="game-controls" style="display: flex; justify-content: space-between; flex-wrap: wrap; width: 100%; max-width: 1000px; gap: 10px;">
    <div id="score-display" class="game-stat">💰 Score: 0</div>
    <div id="streak-display" class="game-stat">🔥 Streak: 0</div>
    <div id="timer-display" class="game-stat">⏱️ 60s</div>
  </div>

  <div id="progress-container" style="width: 100%; max-width: 1000px; background: #ddd; border-radius: 10px; overflow: hidden; height: 20px; margin: 20px 0;">
    <div id="progress-bar"></div>
  </div>

  <div id="game-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; width: 100%; max-width: 1000px;"></div>

  <div class="game-buttons" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
    <button id="back-to-menu" class="game-btn">🔙 Back to Menu</button>
    <button id="export-btn" class="game-btn">📁 Export Results</button>
    <button id="show-leaderboard" class="game-btn">📊 Leaderboard</button>
    <button id="show-stats" class="game-btn">📈 Stats</button>
  </div>
</div>

<!-- Confetti Canvas -->
<canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; pointer-events: none; width: 100vw; height: 100vh; z-index: 1000;"></canvas>

<!-- Leaderboard Modal -->
<div id="leaderboard" class="fade-in">
  <h2>🏅 Leaderboard</h2>
  <ol id="leaderboard-list"></ol>
  <button onclick="document.getElementById('leaderboard').style.display='none'">Close</button>
</div>

<!-- Stats Modal -->
<div id="stats-modal" class="fade-in">
  <h2>📈 Game Stats</h2>
  <p>Total Games Played: <span id="total-games">0</span></p>
  <p>Average Score: <span id="avg-score">0</span></p>
  <p>Best Streak: <span id="top-streak">0</span></p>
  <button onclick="document.getElementById('stats-modal').style.display='none'">Close</button>
</div>
<script>
(function() {
  const gameState = {
    lessons: [
      {
        name: "Lesson 1",
        words: [
          { english: "run", japanese: "走る" },
          { english: "eat", japanese: "食べる" },
          { english: "sleep", japanese: "寝る" },
          { english: "drink", japanese: "飲む" }
        ]
      },
      {
        name: "Lesson 2",
        words: [
          { english: "sun", japanese: "太陽" },
          { english: "moon", japanese: "月" },
          { english: "star", japanese: "星" },
          { english: "cloud", japanese: "雲" }
        ]
      },
      {
        name: "Lesson 3",
        words: [
          { english: "book", japanese: "本" },
          { english: "pen", japanese: "ペン" },
          { english: "desk", japanese: "机" },
          { english: "chair", japanese: "椅子" }
        ]
      }
    ],
    currentLesson: [],
    score: 0,
    streak: 0,
    matches: 0,
    timeLeft: 60,
    timer: null,
    results: [],
    gameActive: false
  };

  const el = {
    startScreen: document.getElementById("start-screen"),
    lessonButtons: document.getElementById("lesson-buttons"),
    gameScreen: document.getElementById("game-screen"),
    gameGrid: document.getElementById("game-grid"),
    progressBar: document.getElementById("progress-bar"),
    timerDisplay: document.getElementById("timer-display"),
    streakDisplay: document.getElementById("streak-display"),
    scoreDisplay: document.getElementById("score-display"),
    bestScore: document.getElementById("best-score"),
    bestStreak: document.getElementById("best-streak"),
    backToMenu: document.getElementById("back-to-menu"),
    exportBtn: document.getElementById("export-btn"),
    darkToggle: document.getElementById("dark-toggle"),
    confettiCanvas: document.getElementById("confetti-canvas"),
    leaderboard: document.getElementById("leaderboard"),
    leaderboardList: document.getElementById("leaderboard-list"),
    showLeaderboard: document.getElementById("show-leaderboard"),
    statsModal: document.getElementById("stats-modal"),
    showStats: document.getElementById("show-stats"),
    totalGames: document.getElementById("total-games"),
    avgScore: document.getElementById("avg-score"),
    topStreak: document.getElementById("top-streak")
  };

  // Utility Functions
  const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
  const speak = word => {
    if ('speechSynthesis' in window) {
      const utter = new SpeechSynthesisUtterance(word);
      utter.lang = 'en-US';
      utter.rate = 0.9;
      window.speechSynthesis.speak(utter);
    }
  };
// Game Setup
function initLessonButtons() {
  el.lessonButtons.innerHTML = "";
  gameState.lessons.forEach((lesson, i) => {
    const btn = document.createElement("button");
    btn.className = "lesson-btn";
    btn.textContent = lesson.name;
    btn.onclick = () => startGame(i);
    el.lessonButtons.appendChild(btn);
  });
}

function startGame(index) {
  const lesson = gameState.lessons[index];
  gameState.currentLesson = lesson.words;
  gameState.score = 0;
  gameState.streak = 0;
  gameState.matches = 0;
  gameState.timeLeft = 60;
  gameState.gameActive = true;
  updateStats();
  updateProgressBar();
  el.startScreen?.classList?.add("hide");
  el.gameScreen.style.display = "flex";
  buildGrid(lesson.words);
  startTimer();
}

function buildGrid(words) {
  el.gameGrid.innerHTML = "";
  const english = shuffle([...words]);
  const japanese = shuffle([...words]);

  english.forEach(w => {
    const elWord = document.createElement("div");
    elWord.className = "draggable";
    elWord.setAttribute("draggable", "true");
    elWord.dataset.word = w.english;
    elWord.textContent = w.english;
    elWord.addEventListener("dragstart", handleDragStart);
    el.gameGrid.appendChild(elWord);
  });

  japanese.forEach(w => {
    const drop = document.createElement("div");
    drop.className = "droppable";
    drop.dataset.match = w.english;
    drop.textContent = w.japanese;
    drop.addEventListener("dragover", e => e.preventDefault());
    drop.addEventListener("drop", handleDrop);
    el.gameGrid.appendChild(drop);
  });
}

function updateStats() {
  el.scoreDisplay.textContent = `💰 Score: ${gameState.score}`;
  el.streakDisplay.textContent = `🔥 Streak: ${gameState.streak}`;
  el.timerDisplay.textContent = `⏱️ ${gameState.timeLeft}s`;
}

function updateProgressBar() {
  const percent = (gameState.matches / gameState.currentLesson.length) * 100;
  el.progressBar.style.width = `${percent}%`;
}

function startTimer() {
  clearInterval(gameState.timer);
  gameState.timer = setInterval(() => {
    gameState.timeLeft--;
    updateStats();
    if (gameState.timeLeft <= 0) {
      clearInterval(gameState.timer);
      endGame();
    }
  }, 1000);
}

function handleDragStart(e) {
  e.dataTransfer.setData("text/plain", e.target.dataset.word);
  speak(e.target.dataset.word);
}

function handleDrop(e) {
  e.preventDefault();
  const dragged = e.dataTransfer.getData("text/plain");
  const target = e.target;
  if (target.classList.contains("matched")) return;

  if (target.dataset.match === dragged) {
    target.classList.add("matched");
    const source = [...document.querySelectorAll(".draggable")]
      .find(el => el.dataset.word === dragged && !el.classList.contains("matched"));
    if (source) source.classList.add("matched");
    gameState.score += 10;
    gameState.streak++;
    gameState.matches++;
    updateStats();
    updateProgressBar();
    if (gameState.matches === gameState.currentLesson.length) endGame();
    triggerConfetti();
  } else {
    gameState.streak = 0;
    updateStats();
  }
}
}

  function endGame() {
    clearInterval(gameState.timer);
    gameState.gameActive = false;
    alert("🎉 Game Over! Your score: " + gameState.score);
    saveStats();
    updateLeaderboard();
    el.gameScreen.style.display = "none";
    document.getElementById("start-screen")?.classList?.remove("hide");
    initLessonButtons();
    updateStats();
  }

  function triggerConfetti() {
    confetti({
      particleCount: 50,
      spread: 70,
      origin: { y: 0.6 },
      colors: ['#7f9ccb', '#ffd18d', '#a8e6cf']
    });
  }

  function saveStats() {
    const results = JSON.parse(localStorage.getItem("vocabStats") || "[]");
    results.push({
      score: gameState.score,
      streak: gameState.streak,
      timestamp: Date.now()
    });
    localStorage.setItem("vocabStats", JSON.stringify(results));
  }

  function updateLeaderboard() {
    const results = JSON.parse(localStorage.getItem("vocabStats") || "[]");
    const topScores = results.sort((a, b) => b.score - a.score).slice(0, 5);
    el.leaderboardList.innerHTML = topScores.map(r => `<li>Score: ${r.score}, Streak: ${r.streak}</li>`).join("");
  }

  function showStats() {
    const results = JSON.parse(localStorage.getItem("vocabStats") || "[]");
    const total = results.length;
    const avg = total ? Math.round(results.reduce((a, b) => a + b.score, 0) / total) : 0;
    const bestStreak = results.reduce((max, r) => Math.max(max, r.streak), 0);
    el.totalGames.textContent = total;
    el.avgScore.textContent = avg;
    el.topStreak.textContent = bestStreak;
    el.statsModal.style.display = "block";
  }

  el.darkToggle.onclick = () => {
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode", document.body.classList.contains("dark") ? "true" : "false");
  };

  el.backToMenu.onclick = () => {
    clearInterval(gameState.timer);
    el.gameScreen.style.display = "none";
    document.getElementById("start-screen").classList.remove("hide");
  };

  el.exportBtn.onclick = () => {
    const results = JSON.parse(localStorage.getItem("vocabStats") || "[]");
    const csv = ["Score,Streak,Timestamp", ...results.map(r => `${r.score},${r.streak},${new Date(r.timestamp).toLocaleString()}`)].join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "vocab_results.csv";
    a.click();
  };

  el.showLeaderboard.onclick = () => {
    updateLeaderboard();
    el.leaderboard.style.display = "block";
  };

  el.showStats.onclick = showStats;

  function init() {
    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark");
    }
    initLessonButtons();
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>