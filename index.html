<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vocabulary Match Game</title>
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet" />
<style>
  /* Reset & base */
  body {
    margin: 0; padding: 0;
    font-family: 'Comic Neue', cursive;
    background: #fefefe;
    color: #222;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    user-select: none;
  }
  h1.title {
    font-size: 2.5rem;
    margin: 20px 0 30px;
    text-align: center;
  }

  /* Start Menu */
  #start-menu {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding: 20px 10px 40px;
    background-color: #fff;
    min-height: 100vh;
    box-sizing: border-box;
  }
  #lesson-buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 14px;
    max-width: 720px;
  }
  #lesson-buttons button {
    background-color: #d6336c;
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 14px 28px;
    font-size: 1.25rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(214,51,108,0.35);
    transition: background-color 0.25s ease, transform 0.2s ease;
    min-width: 140px;
    user-select: none;
  }
  #lesson-buttons button:hover {
    background-color: #ff799b;
    transform: scale(1.05);
  }
  #dark-mode-toggle {
    background: #38b0de;
    color: white;
    padding: 12px 28px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(56,176,222,0.5);
    user-select: none;
    transition: background-color 0.25s ease, transform 0.2s ease;
  }
  #dark-mode-toggle:hover {
    background-color: #64b8e6;
    transform: scale(1.05);
  }

  /* Game Grid */
  #game-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* English left, Japanese right */
    gap: 12px 20px;
    max-width: 800px;
    margin: 30px auto 50px;
  }
  .draggable, .droppable {
    user-select: none;
    font-size: 1.2rem;
    border-radius: 10px;
    padding: 14px 20px;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    cursor: grab;
    background: #fafafa;
    border: 2px solid transparent;
    transition: box-shadow 0.3s ease, background-color 0.3s ease, transform 0.3s ease;
  }
  .draggable:active {
    cursor: grabbing;
  }
  .droppable {
    background: #f0f0f0;
    border: 2px dashed #ccc;
  }
  .matched {
    background-color: #c1f0c1 !important;
    box-shadow: 0 0 15px 3px #57d26f;
    border-color: #57d26f !important;
    cursor: default !important;
  }
  .hide {
    visibility: hidden !important;
  }

  /* Bounce back & shake animation for incorrect drops */
  .bounce-back {
    animation: bounceBack 0.4s ease forwards;
  }
  .shake {
    animation: shakeAnim 0.4s ease forwards;
  }
  @keyframes bounceBack {
    0% { transform: translateY(-20px); }
    50% { transform: translateY(10px); }
    100% { transform: translateY(0); }
  }
  @keyframes shakeAnim {
    0% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    50% { transform: translateX(8px); }
    75% { transform: translateX(-8px); }
    100% { transform: translateX(0); }
  }

  /* Sparkle effect */
  .sparkle {
    position: absolute;
    pointer-events: none;
    width: 12px;
    height: 12px;
    background: #ffd23f;
    border-radius: 50%;
    box-shadow: 0 0 6px 2px #ffd23f;
    animation: sparkleAnim 0.8s ease forwards;
  }
  @keyframes sparkleAnim {
    0% { transform: scale(0.3); opacity: 1; }
    100% { transform: scale(1.5); opacity: 0; }
  }

  /* Progress Bar & Streak */
  #progress-container {
    width: 80%;
    max-width: 800px;
    margin: 10px auto 0;
    background: #eee;
    border-radius: 8px;
    height: 14px;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
  }
  #progress-bar {
    height: 100%;
    width: 0%;
    background: #d6336c;
    border-radius: 8px;
    transition: width 0.3s ease;
  }
  #streak-counter {
    max-width: 800px;
    margin: 6px auto 30px;
    font-weight: 700;
    font-size: 1.2rem;
    text-align: center;
    color: #777;
  }

  /* Dark mode */
  body.dark-mode {
    background: #222;
    color: #ddd;
  }
  body.dark-mode #start-menu {
    background-color: #222;
  }
  body.dark-mode #lesson-buttons button {
    background-color: #b6457a;
    color: #eee;
    box-shadow: 0 4px 8px rgba(182,69,122,0.5);
  }
  body.dark-mode #lesson-buttons button:hover {
    background-color: #d16b9c;
  }
  body.dark-mode #dark-mode-toggle {
    background: #8db4ff;
    color: #222;
    box-shadow: 0 4px 8px rgba(141,180,255,0.6);
  }
  body.dark-mode #dark-mode-toggle:hover {
    background-color: #a6c6ff;
  }
  body.dark-mode #game-grid .draggable,
  body.dark-mode #game-grid .droppable {
    background: #333;
    border-color: #555;
    color: #ddd;
  }
  body.dark-mode #game-grid .droppable {
    border-style: dashed;
  }
  body.dark-mode #game-grid .matched {
    background-color: #4caf50 !important;
    box-shadow: 0 0 15px 3px #7ed57e !important;
    border-color: #7ed57e !important;
  }
</style>
</head>
<body>

  <div id="start-menu" class="active">
    <h1 class="title">Vocabulary Match Game</h1>
    <div id="lesson-buttons"></div>
    <button id="dark-mode-toggle" title="Toggle Dark Mode">🌓 Toggle Dark Mode</button>
  </div>

  <div id="game-grid" style="display:none;"></div>

  <div id="progress-container" style="display:none;">
    <div id="progress-bar"></div>
  </div>
  <div id="streak-counter" style="display:none;">Streak: 0</div>

  <canvas id="confetti-canvas" style="position:fixed; pointer-events:none; top:0; left:0; width:100vw; height:100vh; z-index:9999;"></canvas>

<script>
  
  const lessons = [
    {
      1: [
      {english:"minute", japanese:"分"},
      {english:"before", japanese:"の前に"},
      {english:"photography", japanese:"写真撮影"},
      {english:"tournament", japanese:"トーナメント"},
      {english:"against", japanese:"に対抗して"},
      {english:"lost", japanese:"負けった"},
      {english:"lose", japanese:"負ける"},
      {english:"final", japanese:"最後の"},
      {english:"second", japanese:"秒"},
      {english:"broke", japanese:"壊した"},
      {english:"surely", japanese:"確かに"},
      {english:"until", japanese:"。。。まで"},
      {english:"half", japanese:"半分の"},
      {english:"hour", japanese:"１時間"},
      {english:"tomorrow", japanese:"明日"},
      {english:"today", japanese:"今日"},
      {english:"yesterday", japanese:"昨日"},
      {english:"ago", japanese:"～前に"},
      {english:"spread", japanese:"広める"},
    ],
    2: [
      {english:"if", japanese:"もし"},
      {english:"plastic", japanese:"プラスチック"},
      {english:"exam", japanese:"テスト"},
      {english:"adventure", japanese:"冒険"},
      {english:"read", japanese:"読む"},
      {english:"main", japanese:"主な"},
      {english:"naughty", japanese:"いたずらな"},
      {english:"trouble", japanese:"心配、悩み、やっかいな事態"},
      {english:"lend", japanese:"貸す"},
      {english:"another", japanese:"もう一つの"},
    ],
    3: [
      {english:"think", japanese:"考える・思う"},
      {english:"author", japanese:"作者"},
      {english:"drew", japanese:"描いた"},
      {english:"scenery", japanese:"景色"},
      {english:"in fact", japanese:"今まで"},
      {english:"area", japanese:"地域"},
      {english:"still", japanese:"まだ"},
      {english:"hope", japanese:"望む"},
      {english:"someday", japanese:"いつか"},
      {english:"how", japanese:"どう"},
      {english:"borrow", japanese:"借りる"},
      {english:"fantasy", japanese:"ファンタジー"},
      {english:"message", japanese:"メッセージ"},
      {english:"horror", japanese:"ホラー"},
      {english:"novel", japanese:"小説"},
      {english:"mystery", japanese:"ミステリー"},
      {english:"encourage", japanese:"励ます"},
    ],
    4: [
      {english:"finish", japanese:"終わる"},
      {english:"training", japanese:"トレーニング"},
      {english:"perfect", japanese:"完璧"},
      {english:"learner", japanese:"学習者"},
      {english:"because", japanese:"だから・なので"},
      {english:"easy", japanese:"優しい・簡単な"},
      {english:"plus", japanese:"さらにその上"},
      {english:"teenager", japanese:"１０代の少年"},
      {english:"among", japanese:"の中に・の間に"},
      {english:"ending", japanese:"終わり"},
      {english:"town", japanese:"町"},
      {english:"witch", japanese:"魔女"},
    ],
    5: [
      {english:"famous", japanese:"有名"},
      {english:"dream", japanese:"夢"},
      {english:"build", japanese:"建てる"},
      {english:"tower", japanese:"塔"},
      {english:"around the world", japanese:"世界中"},
      {english:"world", japanese:"世界"},
      {english:"decide", japanese:"決める"},
      {english:"interest", japanese:"興味"},
      {english:"yourself", japanese:"あなた自身"},
      {english:"lots of", japanese:"たくさんの"},
      {english:"bake", japanese:"焼く"},
      {english:"more", japanese:"もっと"},
      {english:"perhaps", japanese:"多分"},
      {english:"bakery", japanese:"パン屋"},
      {english:"need", japanese:"必要"},
    ],
    6: [
      {english:"relax", japanese:"くつろぐ"},
      {english:"customer", japanese:"お客さん"},
      {english:"provide", japanese:"提供する"},
      {english:"several", japanese:"いくつかの"},
      {english:"that way", japanese:"そのようにして"},
      {english:"plenty", japanese:"十分な"},
      {english:"choice", japanese:"選択"},
      {english:"however", japanese:"しかしながら"},
      {english:"leftovers", japanese:"残り物・食べ残し"},
      {english:"away", japanese:"別の方向へ・わきへ"},
      {english:"throw away", japanese:"無駄に使う"},
      {english:"waste", japanese:"無駄"},
      {english:"discount", japanese:"割引"},
      {english:"enough", japanese:"十分な"},
      {english:"help", japanese:"助ける"},
    ],
    7: [
      {english:"pool", japanese:"プール"},
      {english:"over", japanese:"〜以上"},
      {english:"review", japanese:"見直す"},
      {english:"rule", japanese:"規則"},
      {english:"kitchen", japanese:"台所"},
      {english:"must", japanese:"〜しなければならない"},
      {english:"mask", japanese:"マスク"},
      {english:"smartphone", japanese:"スマートフォン"},
      {english:"back", japanese:"戻る"},
      {english:"return", japanese:"返す"},
      {english:"week", japanese:"週"},
      {english:"quiet", japanese:"静かな"},
      {english:"future", japanese:"未来"},
      {english:"in the future", japanese:"将来"},
      {english:"somewhere", japanese:"どこかに"},
      {english:"explore", japanese:"探検する"},
      {english:"clothes", japanese:"服"},
      {english:"design", japanese:"デザイン"},
      {english:"chef", japanese:"シェフ"},
    ],
    8: [
      {english:"as", japanese:"〜として"},
      {english:"behind", japanese:"後ろに"},
      {english:"cut down", japanese:"切り倒す"},
      {english:"building", japanese:"建物"},
      {english:"destroy", japanese:"破壊する"},
      {english:"shock", japanese:"衝撃"},
      {english:"environment", japanese:"環境"},
      {english:"guide", japanese:"案内する"},
      {english:"tour", japanese:"ツアー"},
      {english:"simply", japanese:"単純に"},
      {english:"nothing", japanese:"何も"},
      {english:"worry", japanese:"心配する"},
      {english:"decide", japanese:"決める"},
      {english:"major", japanese:"主要な"},
      {english:"less", japanese:"より少ない"},
      {english:"sell", japanese:"売る"},
      {english:"sold", japanese:"売られた"},
      {english:"knowledge", japanese:"知識"},
      {english:"itself", japanese:"それ自身"},
      {english:"share", japanese:"共有する"},
    ],
    9: [
      {english:"billion", japanese:"１０億"},
      {english:"than", japanese:"。。。よりも"},
      {english:"more than...", japanese:"。。。より多くの"},
      {english:"dirty", japanese:"汚れる"},
      {english:"directly", japanese:"直接"},
      {english:"pond", japanese:"池"},
      {english:"should", japanese:"すべきである"},
      {english:"presentation", japanese:"プレゼンテーション"},
      {english:"everywhere", japanese:"どこでも"},
      {english:"imagine", japanese:"想像する"},
      {english:"step", japanese:"一歩"},
      {english:"situation", japanese:"事態"},
      {english:"one of...", japanese:"の一つ・一人"},
      {english:"collect", japanese:"集める"},
      {english:"drinking water", japanese:"飲み水"},
      {english:"understand", japanese:"理解する"},
      {english:"laundry", japanese:"洗濯物"},
      {english:"available", japanese:"利用できる"},
      {english:"post", japanese:"郵便"},
      {english:"store", japanese:"店"},
      {english:"office", japanese:"事務所"},
    ],
    10: [
      {english:"minute", japanese:"分"},
      {english:"before", japanese:"の前に"},
      {english:"photography", japanese:"写真撮影"},
      {english:"tournament", japanese:"トーナメント"},
      {english:"against", japanese:"に対抗して"},
      {english:"lost", japanese:"負けった"},
      {english:"lose", japanese:"負ける"},
      {english:"final", japanese:"最後の"},
      {english:"second", japanese:"秒"},
      {english:"broke", japanese:"壊した"},
      {english:"surely", japanese:"確かに"},
      {english:"until", japanese:"。。。まで"},
      {english:"half", japanese:"半分の"},
      {english:"hour", japanese:"１時間"},
      {english:"tomorrow", japanese:"明日"},
      {english:"today", japanese:"今日"},
      {english:"yesterday", japanese:"昨日"},
      {english:"ago", japanese:"～前に"},
      {english:"spread", japanese:"広める"},
    ],
    11: [
      {english:"kitchen", japanese:"台所"},
      {english:"must", japanese:"〜しなければならない"},
      {english:"mask", japanese:"マスク"},
      {english:"smartphone", japanese:"スマートフォン"},
      {english:"back", japanese:"戻る"},
      {english:"return", japanese:"返す"},
      {english:"week", japanese:"週"},
      {english:"quiet", japanese:"静かな"},
      {english:"future", japanese:"未来"},
      {english:"in the future", japanese:"将来"},
      {english:"somewhere", japanese:"どこかに"},
      {english:"explore", japanese:"探検する"},
      {english:"clothes", japanese:"服"},
      {english:"design", japanese:"デザイン"},
      {english:"chef", japanese:"シェフ"},
    ],
    12: [
      {english:"as", japanese:"〜として"},
      {english:"behind", japanese:"後ろに"},
      {english:"cut down", japanese:"切り倒す"},
      {english:"building", japanese:"建物"},
      {english:"destroy", japanese:"破壊する"},
      {english:"shock", japanese:"衝撃"},
      {english:"environment", japanese:"環境"},
      {english:"guide", japanese:"案内する"},
      {english:"tour", japanese:"ツアー"},
      {english:"simply", japanese:"単純に"},
      {english:"nothing", japanese:"何も"},
      {english:"worry", japanese:"心配する"},
      {english:"decide", japanese:"決める"},
      {english:"major", japanese:"主要な"},
      {english:"less", japanese:"より少ない"},
      {english:"sell", japanese:"売る"},
      {english:"sold", japanese:"売られた"},
      {english:"knowledge", japanese:"知識"},
      {english:"itself", japanese:"それ自身"},
      {english:"share", japanese:"共有する"},
    ],
    13: [
      {english:"billion", japanese:"１０億"},
      {english:"than", japanese:"。。。よりも"},
      {english:"more than...", japanese:"。。。より多くの"},
      {english:"dirty", japanese:"汚れる"},
      {english:"directly", japanese:"直接"},
      {english:"pond", japanese:"池"},
      {english:"should", japanese:"すべきである"},
      {english:"presentation", japanese:"プレゼンテーション"},
      {english:"everywhere", japanese:"どこでも"},
      {english:"imagine", japanese:"想像する"},
      {english:"step", japanese:"一歩"},
      {english:"situation", japanese:"事態"},
      {english:"one of...", japanese:"の一つ・一人"},
      {english:"collect", japanese:"集める"},
      {english:"drinking water", japanese:"飲み水"},
      {english:"understand", japanese:"理解する"},
      {english:"laundry", japanese:"洗濯物"},
      {english:"available", japanese:"利用できる"},
      {english:"post", japanese:"郵便"},
      {english:"store", japanese:"店"},
      {english:"office", japanese:"事務所"},
    ],
    14: [
      {english:"billion", japanese:"１０億"},
      {english:"than", japanese:"。。。よりも"},
      {english:"more than...", japanese:"。。。より多くの"},
      {english:"dirty", japanese:"汚れる"},
      {english:"directly", japanese:"直接"},
      {english:"pond", japanese:"池"},
      {english:"should", japanese:"すべきである"},
      {english:"presentation", japanese:"プレゼンテーション"},
      {english:"everywhere", japanese:"どこでも"},
      {english:"imagine", japanese:"想像する"},
      {english:"step", japanese:"一歩"},
      {english:"situation", japanese:"事態"},
      {english:"one of...", japanese:"の一つ・一人"},
      {english:"collect", japanese:"集める"},
      {english:"drinking water", japanese:"飲み水"},
      {english:"understand", japanese:"理解する"},
      {english:"laundry", japanese:"洗濯物"},
      {english:"available", japanese:"利用できる"},
      {english:"post", japanese:"郵便"},
      {english:"store", japanese:"店"},
      {english:"office", japanese:"事務所"},
    ],
    15: [
      {english:"minute", japanese:"分"},
      {english:"before", japanese:"の前に"},
      {english:"photography", japanese:"写真撮影"},
      {english:"tournament", japanese:"トーナメント"},
      {english:"against", japanese:"に対抗して"},
      {english:"lost", japanese:"負けった"},
      {english:"lose", japanese:"負ける"},
      {english:"final", japanese:"最後の"},
      {english:"second", japanese:"秒"},
      {english:"broke", japanese:"壊した"},
      {english:"surely", japanese:"確かに"},
      {english:"until", japanese:"。。。まで"},
      {english:"half", japanese:"半分の"},
      {english:"hour", japanese:"１時間"},
      {english:"tomorrow", japanese:"明日"},
      {english:"today", japanese:"今日"},
      {english:"yesterday", japanese:"昨日"},
      {english:"ago", japanese:"～前に"},
      {english:"spread", japanese:"広める"},
    ],
  };

  // Elements
  const startMenu = document.getElementById('start-menu');
  const lessonButtonsContainer = document.getElementById('lesson-buttons');
  const gameGrid = document.getElementById('game-grid');
  const progressContainer = document.getElementById('progress-container');
  const progressBar = document.getElementById('progress-bar');
  const streakCounter = document.getElementById('streak-counter');
  const darkModeToggle = document.getElementById('dark-mode-toggle');
  const confettiCanvas = document.getElementById('confetti-canvas');
  const confettiCtx = confettiCanvas.getContext('2d');

  // Game state variables
  let draggedElement = null;
  let dragOffsetX = 0;
  let dragOffsetY = 0;
  let matchesMade = 0;
  let totalMatches = 0;
  let currentStreak = 0;
  let confettiActive = false;

  // Confetti variables
  let confettiParticles = [];
  let confettiAnimationId = null;

  // Populate lesson buttons
  lessons.forEach((lesson, i) => {
    const btn = document.createElement('button');
    btn.textContent = lesson.name;
    btn.dataset.index = i;
    btn.addEventListener('click', () => startGame(i));
    lessonButtonsContainer.appendChild(btn);
  });

  // Dark mode toggle
  darkModeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
  });

  function startGame(index) {
    // Reset game state
    matchesMade = 0;
    currentStreak = 0;
    updateProgress();
    updateStreak(0);

    // Clear game grid & show
    gameGrid.innerHTML = '';
    startMenu.style.display = 'none';
    gameGrid.style.display = 'grid';
    progressContainer.style.display = 'block';
    streakCounter.style.display = 'block';

    const words = lessons[index].words;
    totalMatches = words.length;

    // Shuffle English and Japanese separately for challenge
    const shuffledEnglish = [...words].sort(() => Math.random() - 0.5);
    const shuffledJapanese = [...words].sort(() => Math.random() - 0.5);

    // Create English draggable boxes - left column
    shuffledEnglish.forEach(pair => {
      const engDiv = document.createElement('div');
      engDiv.className = 'draggable';
      engDiv.textContent = pair.english;
      engDiv.dataset.word = pair.english;
      engDiv.setAttribute('draggable', 'true');

      // Mouse drag events
      engDiv.addEventListener('dragstart', dragStart);
      engDiv.addEventListener('dragend', dragEnd);

      // Touch events
      engDiv.addEventListener('touchstart', touchStart, { passive: false });

      gameGrid.appendChild(engDiv);
    });

    // Create Japanese droppable boxes - right column
    shuffledJapanese.forEach(pair => {
      const japDiv = document.createElement('div');
      japDiv.className = 'droppable';
      japDiv.textContent = pair.japanese;
      japDiv.dataset.match = pair.english;

      // Drag and touch drop events
      japDiv.addEventListener('dragover', e => e.preventDefault());
      japDiv.addEventListener('drop', dropHandler);

      gameGrid.appendChild(japDiv);
    });
  }

  // Drag & Drop handlers for mouse
  function dragStart(e) {
    draggedElement = e.target;
    dragOffsetX = e.offsetX;
    dragOffsetY = e.offsetY;
    e.dataTransfer.setData('text/plain', draggedElement.dataset.word);
    setTimeout(() => draggedElement.classList.add('hide'), 0);

    // Play audio for English word
    playAudio(draggedElement.textContent);
  }
  function dragEnd(e) {
    if(draggedElement){
      draggedElement.classList.remove('hide');
      draggedElement.style.position = '';
      draggedElement.style.left = '';
      draggedElement.style.top = '';
      draggedElement.style.zIndex = '';
      draggedElement = null;
    }
  }
  function dropHandler(e) {
    e.preventDefault();
    const dropTarget = e.target.closest('.droppable');
    if (!dropTarget || !draggedElement) return;

    const draggedWord = draggedElement.dataset.word;
    if (dropTarget.dataset.match === draggedWord) {
      onCorrectMatch(dropTarget, draggedElement);
    } else {
      onIncorrectMatch(draggedElement);
    }
  }

  // Touch drag handlers
  function touchStart(e) {
    e.preventDefault();
    draggedElement = e.target;
    const touch = e.touches[0];

    const rect = draggedElement.getBoundingClientRect();
    dragOffsetX = touch.clientX - rect.left;
    dragOffsetY = touch.clientY - rect.top;

    draggedElement.style.position = 'absolute';
    draggedElement.style.zIndex = 10000;
    draggedElement.style.width = `${rect.width}px`;
    draggedElement.style.height = `${rect.height}px`;
    moveAt(touch.clientX, touch.clientY);

    document.addEventListener('touchmove', touchMove, { passive: false });
    document.addEventListener('touchend', touchEnd);
  }
  function touchMove(e) {
    e.preventDefault();
    const touch = e.touches[0];
    moveAt(touch.clientX, touch.clientY);
  }
  function touchEnd(e) {
    const touch = e.changedTouches[0];
    const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    if (!elemBelow) {
      cancelTouchDrag();
      return;
    }
    const dropTarget = elemBelow.closest('.droppable');
    if (dropTarget && draggedElement) {
      if (dropTarget.dataset.match === draggedElement.dataset.word) {
        onCorrectMatch(dropTarget, draggedElement);
      } else {
        onIncorrectMatch(draggedElement);
      }
    } else {
      onIncorrectMatch(draggedElement);
    }
    cancelTouchDrag();
  }
  function cancelTouchDrag() {
    if (!draggedElement) return;
    draggedElement.style.position = '';
    draggedElement.style.left = '';
    draggedElement.style.top = '';
    draggedElement.style.zIndex = '';
    draggedElement.style.width = '';
    draggedElement.style.height = '';
    draggedElement = null;
    document.removeEventListener('touchmove', touchMove);
    document.removeEventListener('touchend', touchEnd);
  }
  function moveAt(pageX, pageY) {
    if (!draggedElement) return;
    draggedElement.style.left = pageX - dragOffsetX + 'px';
    draggedElement.style.top = pageY - dragOffsetY + 'px';
  }

  // Match handlers
  function onCorrectMatch(dropTarget, draggedEl) {
    dropTarget.classList.add('matched');
    draggedEl.classList.add('matched');
    draggedEl.setAttribute('draggable', 'false');

    // Snap English box on top of Japanese
    const dropRect = dropTarget.getBoundingClientRect();
    const parentRect = gameGrid.getBoundingClientRect();

    draggedEl.style.position = 'absolute';
    draggedEl.style.left = (dropRect.left - parentRect.left) + 'px';
    draggedEl.style.top = (dropRect.top - parentRect.top) + 'px';
    draggedEl.style.width = dropRect.width + 'px';
    draggedEl.style.height = dropRect.height + 'px';
    draggedEl.style.zIndex = 500;

    // Remove event listeners to disable drag after matched
    draggedEl.removeEventListener('dragstart', dragStart);
    draggedEl.removeEventListener('touchstart', touchStart);

    matchesMade++;
    currentStreak++;
    updateProgress();
    updateStreak(currentStreak);
    playAudio(draggedEl.textContent);
    createSparkle(draggedEl);

    if (matchesMade === totalMatches) {
      launchConfetti();
      setTimeout(() => alert('🎉 Congratulations! You matched all words!'), 100);
    }
  }
  function onIncorrectMatch(el) {
    currentStreak = 0;
    updateStreak(currentStreak);
    // Shake & bounce animation
    el.classList.add('shake');
    setTimeout(() => {
      el.classList.remove('shake');
      bounceBack(el);
    }, 400);
    playErrorSound();
  }

  // Bounce back animation
  function bounceBack(el) {
    el.style.transition = 'transform 0.4s ease';
    el.style.transform = 'translateY(-20px)';
    setTimeout(() => {
      el.style.transform = 'translateY(0)';
    }, 200);
    setTimeout(() => {
      el.style.transition = '';
      el.style.transform = '';
      // Reset position for touch drag
      if(el.style.position === 'absolute' && !el.classList.contains('matched')){
        el.style.position = '';
        el.style.left = '';
        el.style.top = '';
        el.style.width = '';
        el.style.height = '';
        el.style.zIndex = '';
      }
    }, 400);
  }

  // Progress & streak
  function updateProgress() {
    const pct = (matchesMade / totalMatches) * 100;
    progressBar.style.width = pct + '%';
  }
  function updateStreak(count) {
    streakCounter.textContent = count >= 3 ? `🔥 Streak: ${count}` : `Streak: ${count}`;
    if (count >= 3) createSparkle(streakCounter);
  }

  // Audio: Use speech synthesis to say English word
  function playAudio(word) {
    if (!('speechSynthesis' in window)) return;
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.lang = 'en-US';
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
  }
  // Play error sound using Web Audio API
  function playErrorSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    oscillator.type = 'square';
    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
    oscillator.connect(audioCtx.destination);
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.1);
  }

  // Sparkle effect
  function createSparkle(parent) {
    const sparkle = document.createElement('div');
    sparkle.classList.add('sparkle');
    parent.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 800);
  }

  // Confetti launcher & animation (simple)
  function launchConfetti() {
    if (confettiActive) return;
    confettiActive = true;
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;

    const colors = ['#d6336c', '#fcd5ce', '#f9a8d4', '#ff80ab', '#c9184a'];
    confettiParticles = [];
    for (let i = 0; i < 150; i++) {
      confettiParticles.push({
        x: Math.random() * confettiCanvas.width,
        y: Math.random() * confettiCanvas.height - confettiCanvas.height,
        r: Math.random() * 7 + 3,
        d: Math.random() * 30 + 10,
        color: colors[Math.floor(Math.random() * colors.length)],
        tilt: Math.random() * 10 - 10,
        tiltAngle: 0,
        tiltAngleIncrement: (Math.random() * 0.07) + 0.05
      });
    }
    animateConfetti();
  }
  function animateConfetti() {
    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    confettiParticles.forEach(p => {
      p.tiltAngle += p.tiltAngleIncrement;
      p.y += (Math.cos(p.d) + 3 + p.r / 2) / 2;
      p.x += Math.sin(p.tiltAngle);
      p.tilt = Math.sin(p.tiltAngle) * 15;

      confettiCtx.beginPath();
      confettiCtx.lineWidth = p.r;
      confettiCtx.strokeStyle = p.color;
      confettiCtx.moveTo(p.x + p.tilt + p.r / 2, p.y);
      confettiCtx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r / 2);
      confettiCtx.stroke();

      if (p.y > confettiCanvas.height) {
        p.x = Math.random() * confettiCanvas.width;
        p.y = -10;
      }
    });
    confettiAnimationId = requestAnimationFrame(animateConfetti);
    // Stop confetti after 5 seconds
    setTimeout(() => {
      cancelAnimationFrame(confettiAnimationId);
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      confettiActive = false;
    }, 5000);
  }

  // Resize confetti canvas on window resize
  window.addEventListener('resize', () => {
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  });
</script>

</body>
</html>
