<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vocabulary Match Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Comic Neue', cursive;
      margin: 0;
      padding: 0;
      background-color: #fff8f4;
      transition: background 0.4s, color 0.4s;
    }
    body.dark {
      background-color: #1e1e1e;
      color: #fefefe;
    }
    button {
      font-family: 'Comic Neue', cursive;
      padding: 10px 20px;
      font-size: 1.2em;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: #ffccdc;
      transition: transform 0.2s, background 0.3s;
    }
    button:hover {
      transform: scale(1.05);
      background-color: #ffbcd0;
    }
    .title {
      text-align: center;
      font-size: 2.5em;
      margin: 20px 0;
    }
    #start-menu {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 20px;
    }
    #lesson-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      width: 90%;
      max-width: 800px;
    }
    #game-container {
      display: none;
      padding: 20px;
    }
    #game-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .draggable, .droppable {
      padding: 10px;
      border: 2px solid #ccc;
      background-color: #fff;
      text-align: center;
      border-radius: 8px;
      user-select: none;
      transition: all 0.3s;
      font-size: 1.1em;
    }
    .draggable {
      background-color: #f9f9ff;
      cursor: grab;
      position: relative;
    }
    .droppable {
      background-color: #eef6ff;
      min-height: 40px;
    }
    .matched {
      background-color: #c8f7c5 !important;
      border-color: #8ed18d !important;
    }
    .hide {
      visibility: hidden;
    }
    .bounce {
      animation: bounce 0.3s;
    }
    .flash-red {
      background-color: #ffb3b3 !important;
      border-color: red !important;
    }
    @keyframes bounce {
      0% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0); }
    }
    #progress-container, #streak-counter {
      margin-top: 10px;
      text-align: center;
    }
    #progress-bar {
      height: 10px;
      background-color: #4caf50;
      width: 0%;
      transition: width 0.5s;
      border-radius: 5px;
    }
    #end-screen {
      display: none;
      text-align: center;
      padding: 30px;
    }
    canvas#confetti-canvas {
      position: fixed;
      pointer-events: none;
      top: 0;
      left: 0;
      z-index: 1000;
    }
    .dark .draggable,
    .dark .droppable {
      background-color: #333;
      border-color: #666;
      color: #fff;
    }
    .dark .droppable {
      background-color: #444;
    }
    .sparkle {
      animation: sparkle 1.2s ease-in-out infinite;
    }
    @keyframes sparkle {
      0%, 100% { text-shadow: 0 0 6px #fff, 0 0 12px #ff66cc, 0 0 18px #ff66cc; }
      50% { text-shadow: 0 0 3px #fff, 0 0 6px #ff66cc, 0 0 9px #ff66cc; }
    }
  </style>
</head>
<body>
  <div id="start-menu">
    <h1 class="title">Vocabulary Match Game</h1>
    <div id="lesson-buttons"></div>
    <button id="challenge-btn">🔥 Challenge Mode</button>
    <button id="dark-mode-toggle">🌓 Toggle Dark Mode</button>
  </div>

  <div id="game-container">
    <div id="progress-container"><div id="progress-bar"></div></div>
    <div id="streak-counter"></div>
    <div id="game-grid"></div>
  </div>

  <div id="end-screen">
    <h2 id="end-title"></h2>
    <p id="end-summary"></p>
    <p id="end-score"></p>
    <button id="restart-btn">🔁 Try Again</button>
    <button id="back-to-menu-btn">🔙 Back to Menu</button>
  </div>

  <canvas id="confetti-canvas"></canvas>
<script>
  // Confetti helper library (simple version)
  // Source: https://www.kirilv.com/canvas-confetti/
  class Confetti {
    constructor(canvas) {
      this.canvas = canvas;
      this.ctx = canvas.getContext('2d');
      this.particles = [];
      this.width = window.innerWidth;
      this.height = window.innerHeight;
      canvas.width = this.width;
      canvas.height = this.height;
      window.addEventListener('resize', () => {
        this.width = window.innerWidth;
        this.height = window.innerHeight;
        canvas.width = this.width;
        canvas.height = this.height;
      });
    }
    createParticle() {
      const colors = ['#ff66cc', '#ffb3d9', '#cc3399', '#ff99cc', '#ff4d94'];
      return {
        x: Math.random() * this.width,
        y: Math.random() * this.height - this.height,
        size: Math.random() * 7 + 3,
        speedY: Math.random() * 3 + 2,
        color: colors[Math.floor(Math.random() * colors.length)],
        opacity: 1,
        decay: Math.random() * 0.01 + 0.005,
      };
    }
    start() {
      for(let i=0; i<150; i++) this.particles.push(this.createParticle());
      this.animate();
    }
    animate() {
      this.ctx.clearRect(0, 0, this.width, this.height);
      this.particles.forEach((p, i) => {
        p.y += p.speedY;
        p.opacity -= p.decay;
        if (p.opacity <= 0) {
          this.particles[i] = this.createParticle();
        }
        this.ctx.fillStyle = `rgba(${this.hexToRgb(p.color)},${p.opacity})`;
        this.ctx.beginPath();
        this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        this.ctx.fill();
      });
      this.animFrame = requestAnimationFrame(this.animate.bind(this));
    }
    stop() {
      cancelAnimationFrame(this.animFrame);
      this.ctx.clearRect(0,0,this.width,this.height);
      this.particles = [];
    }
    hexToRgb(hex) {
      hex = hex.replace('#','');
      const bigint = parseInt(hex,16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `${r},${g},${b}`;
    }
  }

  // Vocabulary data for 14 lessons (sample for 2 lessons shown; add more as needed)
  const lessons = [
  {
    name: "Lesson 1",
    words: [
      {english: "minute", japanese: "分"},
      {english: "before", japanese: "の前に"},
      {english: "photography", japanese: "写真撮影"},
      {english: "tournament", japanese: "トーナメント"},
      {english: "against", japanese: "に対抗して"},
      {english: "lost", japanese: "負けった"},
      {english: "lose", japanese: "負ける"},
      {english: "final", japanese: "最後の"},
      {english: "second", japanese: "秒"},
      {english: "broke", japanese: "壊した"},
      {english: "surely", japanese: "確かに"},
      {english: "until", japanese: "。。。まで"},
      {english: "half", japanese: "半分の"},
      {english: "hour", japanese: "１時間"},
      {english: "tomorrow", japanese: "明日"},
      {english: "today", japanese: "今日"},
      {english: "yesterday", japanese: "昨日"},
      {english: "ago", japanese: "～前に"},
      {english: "spread", japanese: "広める"},
      {english: "stadium", japanese: "スタジアム"}
    ]
  },
  {
    name: "Lesson 2",
    words: [
      {english: "delicious", japanese: "おいしい"},
      {english: "happy", japanese: "幸せ"},
      {english: "run", japanese: "走る"},
      {english: "draw", japanese: "描く"},
      {english: "build", japanese: "建てる"},
      {english: "carry", japanese: "運ぶ"},
      {english: "open", japanese: "開ける"},
      {english: "close", japanese: "閉じる"},
      {english: "wake up", japanese: "目を覚ます"},
      {english: "sleep", japanese: "眠る"},
      {english: "stand", japanese: "立つ"},
      {english: "sit", japanese: "座る"},
      {english: "jump", japanese: "跳ぶ"},
      {english: "swim", japanese: "泳ぐ"},
      {english: "drive", japanese: "運転する"},
      {english: "listen", japanese: "聞く"},
      {english: "write", japanese: "書く"},
      {english: "read", japanese: "読む"},
      {english: "speak", japanese: "話す"},
      {english: "learn", japanese: "学ぶ"}
    ]
  },
  {
    name: "Lesson 3",
    words: [
      {english: "teacher", japanese: "先生"},
      {english: "student", japanese: "生徒"},
      {english: "classroom", japanese: "教室"},
      {english: "library", japanese: "図書館"},
      {english: "desk", japanese: "机"},
      {english: "chair", japanese: "椅子"},
      {english: "blackboard", japanese: "黒板"},
      {english: "homework", japanese: "宿題"},
      {english: "test", japanese: "テスト"},
      {english: "question", japanese: "質問"},
      {english: "answer", japanese: "答え"},
      {english: "listen", japanese: "聞く"},
      {english: "read", japanese: "読む"},
      {english: "write", japanese: "書く"},
      {english: "speak", japanese: "話す"},
      {english: "understand", japanese: "理解する"},
      {english: "learn", japanese: "学ぶ"},
      {english: "practice", japanese: "練習する"},
      {english: "study", japanese: "勉強する"},
      {english: "remember", japanese: "覚える"}
    ]
  },
  {
    name: "Lesson 4",
    words: [
      {english: "apple", japanese: "りんご"},
      {english: "banana", japanese: "バナナ"},
      {english: "grape", japanese: "ぶどう"},
      {english: "orange", japanese: "オレンジ"},
      {english: "watermelon", japanese: "スイカ"},
      {english: "strawberry", japanese: "いちご"},
      {english: "peach", japanese: "もも"},
      {english: "pineapple", japanese: "パイナップル"},
      {english: "cherry", japanese: "さくらんぼ"},
      {english: "melon", japanese: "メロン"},
      {english: "pear", japanese: "なし"},
      {english: "lemon", japanese: "レモン"},
      {english: "mango", japanese: "マンゴー"},
      {english: "blueberry", japanese: "ブルーベリー"},
      {english: "kiwi", japanese: "キウイ"},
      {english: "coconut", japanese: "ココナッツ"},
      {english: "fig", japanese: "いちじく"},
      {english: "date", japanese: "なつめやし"},
      {english: "papaya", japanese: "パパイヤ"},
      {english: "plum", japanese: "うめ"}
    ]
  },
  {
    name: "Lesson 5",
    words: [
      {english: "cat", japanese: "猫"},
      {english: "dog", japanese: "犬"},
      {english: "bird", japanese: "鳥"},
      {english: "fish", japanese: "魚"},
      {english: "rabbit", japanese: "うさぎ"},
      {english: "horse", japanese: "馬"},
      {english: "cow", japanese: "牛"},
      {english: "pig", japanese: "豚"},
      {english: "sheep", japanese: "羊"},
      {english: "chicken", japanese: "鶏"},
      {english: "duck", japanese: "アヒル"},
      {english: "turtle", japanese: "亀"},
      {english: "frog", japanese: "カエル"},
      {english: "lion", japanese: "ライオン"},
      {english: "tiger", japanese: "トラ"},
      {english: "elephant", japanese: "象"},
      {english: "bear", japanese: "クマ"},
      {english: "monkey", japanese: "サル"},
      {english: "wolf", japanese: "オオカミ"},
      {english: "fox", japanese: "キツネ"}
    ]
  },
  {
    name: "Lesson 6",
    words: [
      {english: "car", japanese: "車"},
      {english: "bicycle", japanese: "自転車"},
      {english: "bus", japanese: "バス"},
      {english: "train", japanese: "電車"},
      {english: "airplane", japanese: "飛行機"},
      {english: "boat", japanese: "ボート"},
      {english: "truck", japanese: "トラック"},
      {english: "motorcycle", japanese: "オートバイ"},
      {english: "subway", japanese: "地下鉄"},
      {english: "taxi", japanese: "タクシー"},
      {english: "helicopter", japanese: "ヘリコプター"},
      {english: "scooter", japanese: "スクーター"},
      {english: "van", japanese: "バン"},
      {english: "tram", japanese: "路面電車"},
      {english: "ferry", japanese: "フェリー"},
      {english: "cruise", japanese: "クルーズ"},
      {english: "rocket", japanese: "ロケット"},
      {english: "skateboard", japanese: "スケートボード"},
      {english: "rollerblades", japanese: "ローラーブレード"},
      {english: "hoverboard", japanese: "ホバーボード"}
    ]
  },
  {
    name: "Lesson 7",
    words: [
      {english: "red", japanese: "赤"},
      {english: "blue", japanese: "青"},
      {english: "green", japanese: "緑"},
      {english: "yellow", japanese: "黄色"},
      {english: "black", japanese: "黒"},
      {english: "white", japanese: "白"},
      {english: "pink", japanese: "ピンク"},
      {english: "orange", japanese: "オレンジ"},
      {english: "purple", japanese: "紫"},
      {english: "brown", japanese: "茶色"},
      {english: "gray", japanese: "灰色"},
      {english: "gold", japanese: "金色"},
      {english: "silver", japanese: "銀色"},
      {english: "beige", japanese: "ベージュ"},
      {english: "turquoise", japanese: "ターコイズ"},
      {english: "navy", japanese: "ネイビー"},
      {english: "lavender", japanese: "ラベンダー"},
      {english: "maroon", japanese: "マルーン"},
      {english: "teal", japanese: "ティール"},
      {english: "magenta", japanese: "マゼンタ"}
    ]
  },
  {
    name: "Lesson 8",
    words: [
      {english: "happy", japanese: "幸せ"},
      {english: "sad", japanese: "悲しい"},
      {english: "angry", japanese: "怒っている"},
      {english: "tired", japanese: "疲れた"},
      {english: "excited", japanese: "興奮している"},
      {english: "nervous", japanese: "緊張している"},
      {english: "scared", japanese: "怖い"},
      {english: "bored", japanese: "退屈している"},
      {english: "surprised", japanese: "驚いた"},
      {english: "proud", japanese: "誇りに思う"},
      {english: "calm", japanese: "落ち着いた"},
      {english: "confused", japanese: "混乱した"},
      {english: "jealous", japanese: "嫉妬している"},
      {english: "lonely", japanese: "孤独"},
      {english: "relaxed", japanese: "リラックスした"},
      {english: "hopeful", japanese: "希望に満ちた"},
      {english: "grateful", japanese: "感謝している"},
      {english: "shy", japanese: "恥ずかしがり屋"},
      {english: "friendly", japanese: "友好的な"},
      {english: "kind", japanese: "親切な"}
    ]
  },
  {
    name: "Lesson 9",
    words: [
      {english: "Monday", japanese: "月曜日"},
      {english: "Tuesday", japanese: "火曜日"},
      {english: "Wednesday", japanese: "水曜日"},
      {english: "Thursday", japanese: "木曜日"},
      {english: "Friday", japanese: "金曜日"},
      {english: "Saturday", japanese: "土曜日"},
      {english: "Sunday", japanese: "日曜日"},
      {english: "week", japanese: "週"},
      {english: "month", japanese: "月"},
      {english: "year", japanese: "年"},
      {english: "today", japanese: "今日"},
      {english: "tomorrow", japanese: "明日"},
      {english: "yesterday", japanese: "昨日"},
      {english: "holiday", japanese: "休日"},
      {english: "season", japanese: "季節"},
      {english: "spring", japanese: "春"},
      {english: "summer", japanese: "夏"},
      {english: "autumn", japanese: "秋"},
      {english: "winter", japanese: "冬"},
      {english: "calendar", japanese: "カレンダー"}
    ]
  },
  {
    name: "Lesson 10",
    words: [
      {english: "food", japanese: "食べ物"},
      {english: "water", japanese: "水"},
      {english: "bread", japanese: "パン"},
      {english: "rice", japanese: "ご飯"},
      {english: "meat", japanese: "肉"},
      {english: "fish", japanese: "魚"},
      {english: "vegetables", japanese: "野菜"},
      {english: "fruit", japanese: "果物"},
      {english: "soup", japanese: "スープ"},
      {english: "salad", japanese: "サラダ"},
      {english: "dessert", japanese: "デザート"},
      {english: "coffee", japanese: "コーヒー"},
      {english: "tea", japanese: "お茶"},
      {english: "milk", japanese: "牛乳"},
      {english: "juice", japanese: "ジュース"},
      {english: "breakfast", japanese: "朝食"},
      {english: "lunch", japanese: "昼食"},
      {english: "dinner", japanese: "夕食"},
      {english: "snack", japanese: "おやつ"},
      {english: "restaurant", japanese: "レストラン"}
    ]
  },
  {
    name: "Lesson 11",
    words: [
      {english: "family", japanese: "家族"},
      {english: "mother", japanese: "母"},
      {english: "father", japanese: "父"},
      {english: "brother", japanese: "兄弟"},
      {english: "sister", japanese: "姉妹"},
      {english: "grandmother", japanese: "祖母"},
      {english: "grandfather", japanese: "祖父"},
      {english: "uncle", japanese: "おじ"},
      {english: "aunt", japanese: "おば"},
      {english: "cousin", japanese: "いとこ"},
      {english: "child", japanese: "子供"},
      {english: "baby", japanese: "赤ちゃん"},
      {english: "husband", japanese: "夫"},
      {english: "wife", japanese: "妻"},
      {english: "parent", japanese: "親"},
      {english: "relative", japanese: "親戚"},
      {english: "neighbor", japanese: "隣人"},
      {english: "friend", japanese: "友達"},
      {english: "teacher", japanese: "先生"},
      {english: "student", japanese: "学生"}
    ]
  },
  {
    name: "Lesson 12",
    words: [
      {english: "school", japanese: "学校"},
      {english: "class", japanese: "クラス"},
      {english: "teacher", japanese: "先生"},
      {english: "student", japanese: "学生"},
      {english: "lesson", japanese: "授業"},
      {english: "homework", japanese: "宿題"},
      {english: "test", japanese: "テスト"},
      {english: "book", japanese: "本"},
      {english: "notebook", japanese: "ノート"},
      {english: "pen", japanese: "ペン"},
      {english: "pencil", japanese: "鉛筆"},
      {english: "eraser", japanese: "消しゴム"},
      {english: "desk", japanese: "机"},
      {english: "chair", japanese: "椅子"},
      {english: "blackboard", japanese: "黒板"},
      {english: "library", japanese: "図書館"},
      {english: "computer", japanese: "コンピューター"},
      {english: "teacher", japanese: "教師"},
      {english: "student", japanese: "生徒"},
      {english: "grade", japanese: "成績"}
    ]
  },
  {
    name: "Lesson 13",
    words: [
      {english: "weather", japanese: "天気"},
      {english: "sunny", japanese: "晴れ"},
      {english: "rainy", japanese: "雨"},
      {english: "cloudy", japanese: "曇り"},
      {english: "snowy", japanese: "雪"},
      {english: "windy", japanese: "風が強い"},
      {english: "hot", japanese: "暑い"},
      {english: "cold", japanese: "寒い"},
      {english: "storm", japanese: "嵐"},
      {english: "temperature", japanese: "気温"},
      {english: "season", japanese: "季節"},
      {english: "spring", japanese: "春"},
      {english: "summer", japanese: "夏"},
      {english: "autumn", japanese: "秋"},
      {english: "winter", japanese: "冬"},
      {english: "foggy", japanese: "霧がかかった"},
      {english: "hail", japanese: "雹"},
      {english: "thunder", japanese: "雷"},
      {english: "lightning", japanese: "稲妻"},
      {english: "humidity", japanese: "湿度"}
    ]
  },
  {
    name: "Lesson 14",
    words: [
      {english: "family", japanese: "家族"},
      {english: "friend", japanese: "友達"},
      {english: "love", japanese: "愛"},
      {english: "hate", japanese: "憎しみ"},
      {english: "joy", japanese: "喜び"},
      {english: "sadness", japanese: "悲しみ"},
      {english: "anger", japanese: "怒り"},
      {english: "fear", japanese: "恐れ"},
      {english: "hope", japanese: "希望"},
      {english: "peace", japanese: "平和"},
      {english: "trust", japanese: "信頼"},
      {english: "dream", japanese: "夢"},
      {english: "luck", japanese: "運"},
      {english: "success", japanese: "成功"},
      {english: "failure", japanese: "失敗"},
      {english: "courage", japanese: "勇気"},
      {english: "honesty", japanese: "正直"},
      {english: "kindness", japanese: "親切"},
      {english: "patience", japanese: "忍耐"},
      {english: "wisdom", japanese: "知恵"}
    ]
  }
];

  // Elements references
  const lessonButtons = document.getElementById('lesson-buttons');
  const startMenu = document.getElementById('start-menu');
  const gameContainer = document.getElementById('game-container');
  const gameGrid = document.getElementById('game-grid');
  const progressBar = document.getElementById('progress-bar');
  const streakCounter = document.getElementById('streak-counter');
  const endScreen = document.getElementById('end-screen');
  const endTitle = document.getElementById('end-title');
  const endSummary = document.getElementById('end-summary');
  const endScore = document.getElementById('end-score');
  const restartBtn = document.getElementById('restart-btn');
  const backToMenuBtn = document.getElementById('back-to-menu-btn');
  const challengeBtn = document.getElementById('challenge-btn');
  const darkModeToggle = document.getElementById('dark-mode-toggle');
  const confettiCanvas = document.getElementById('confetti-canvas');
  const confetti = new Confetti(confettiCanvas);

  let currentLesson = null;
  let pairsMatched = 0;
  let totalPairs = 0;
  let streak = 0;
  let challengeMode = false;
  let challengeTimer = null;
  let challengeTimeLeft = 120; // seconds

  // Audio synthesis for English words
  function speak(word) {
    if (!window.speechSynthesis) return;
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.lang = 'en-US';
    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
  }

  // Setup lesson buttons
  function setupLessonButtons() {
    lessonButtons.innerHTML = '';
    lessons.forEach((lesson, i) => {
      const btn = document.createElement('button');
      btn.textContent = lesson.name;
      btn.addEventListener('click', () => startGame(i, false));
      lessonButtons.appendChild(btn);
    });
  }

  // Start game with lesson index and challenge mode flag
  function startGame(index, isChallenge) {
    currentLesson = lessons[index];
    challengeMode = !!isChallenge;
    pairsMatched = 0;
    streak = 0;
    updateStreakDisplay();
    startMenu.style.display = 'none';
    endScreen.style.display = 'none';
    gameContainer.style.display = 'block';
    gameGrid.innerHTML = '';
    progressBar.style.width = '0%';

    const shuffledEnglish = shuffleArray(currentLesson.words.map(w => w.english));
    const shuffledJapanese = shuffleArray(currentLesson.words.map(w => w.japanese));

    totalPairs = currentLesson.words.length;

    // Create English draggable boxes
    shuffledEnglish.forEach(word => {
      const div = document.createElement('div');
      div.className = 'draggable';
      div.textContent = word;
      div.setAttribute('draggable', true);
      div.dataset.word = word;
      addDragAndTouchHandlers(div);
      gameGrid.appendChild(div);
    });

    // Create Japanese droppable boxes
    shuffledJapanese.forEach(word => {
      const div = document.createElement('div');
      div.className = 'droppable';
      div.textContent = word;
      const pair = currentLesson.words.find(w => w.japanese === word);
      div.dataset.match = pair ? pair.english : '';
      gameGrid.appendChild(div);
    });

    if (challengeMode) {
      startChallengeTimer();
    } else {
      stopChallengeTimer();
    }
  }

  // Shuffle helper
  function shuffleArray(arr) {
    const copy = arr.slice();
    for (let i = copy.length -1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i+1));
      [copy[i], copy[j]] = [copy[j], copy[i]];
    }
    return copy;
  }

  // Update progress bar
  function updateProgress() {
    const percent = (pairsMatched / totalPairs) * 100;
    progressBar.style.width = percent + '%';
  }

  // Update streak display
  function updateStreakDisplay() {
    if (streak >= 3) {
      streakCounter.innerHTML = `🔥 Streak: <span class="sparkle">${streak}</span>`;
    } else if (streak > 0) {
      streakCounter.textContent = `Streak: ${streak}`;
    } else {
      streakCounter.textContent = '';
    }
  }
  // Add drag and touch event listeners to English draggable divs
  function addDragAndTouchHandlers(div) {
    // Mouse drag
    div.addEventListener('dragstart', dragStart);
    div.addEventListener('dragend', dragEnd);

    // Touch drag
    div.addEventListener('touchstart', touchStart, {passive:false});
  }

  let draggedElement = null;
  let originalX = 0;
  let originalY = 0;
  let offsetX = 0;
  let offsetY = 0;

  function dragStart(e) {
    draggedElement = e.target;
    speak(draggedElement.textContent);
    e.dataTransfer.setData('text/plain', draggedElement.dataset.word);
    setTimeout(() => {
      draggedElement.classList.add('hide');
    }, 0);
  }

  function dragEnd(e) {
    if (draggedElement) {
      draggedElement.classList.remove('hide');
      draggedElement.style.position = '';
      draggedElement.style.zIndex = '';
      draggedElement.style.left = '';
      draggedElement.style.top = '';
      draggedElement = null;
    }
  }

  gameGrid.addEventListener('dragover', e => {
    e.preventDefault();
  });

  gameGrid.addEventListener('drop', e => {
    e.preventDefault();
    if (!draggedElement) return;
    const dropTarget = e.target.closest('.droppable');
    if (!dropTarget) return;
    const draggedWord = draggedElement.dataset.word;
    if (dropTarget.dataset.match === draggedWord) {
      onCorrectMatch(draggedElement, dropTarget);
    } else {
      onWrongMatch(draggedElement);
    }
  });

  // Touch drag functions
  function touchStart(e) {
    e.preventDefault();
    draggedElement = e.target;
    speak(draggedElement.textContent);
    draggedElement.style.position = 'absolute';
    draggedElement.style.zIndex = 1000;
    const touch = e.touches[0];
    originalX = draggedElement.offsetLeft;
    originalY = draggedElement.offsetTop;
    offsetX = touch.clientX - originalX;
    offsetY = touch.clientY - originalY;
    moveAt(touch.pageX, touch.pageY);
    document.addEventListener('touchmove', touchMove, {passive:false});
    document.addEventListener('touchend', touchEnd);
  }

  function moveAt(pageX, pageY) {
    if (!draggedElement) return;
    draggedElement.style.left = (pageX - offsetX) + 'px';
    draggedElement.style.top = (pageY - offsetY) + 'px';
  }

  function touchMove(e) {
    e.preventDefault();
    const touch = e.touches[0];
    moveAt(touch.pageX, touch.pageY);
  }

  function touchEnd(e) {
    e.preventDefault();
    const touch = e.changedTouches[0];
    const dropElem = document.elementFromPoint(touch.clientX, touch.clientY);
    if (dropElem && dropElem.classList.contains('droppable')) {
      const draggedWord = draggedElement.dataset.word;
      if (dropElem.dataset.match === draggedWord) {
        onCorrectMatch(draggedElement, dropElem);
      } else {
        onWrongMatch(draggedElement);
      }
    } else {
      onWrongMatch(draggedElement);
    }
    resetDraggedElement();
    document.removeEventListener('touchmove', touchMove);
    document.removeEventListener('touchend', touchEnd);
  }

  function resetDraggedElement() {
    if (!draggedElement) return;
    draggedElement.style.position = '';
    draggedElement.style.zIndex = '';
    draggedElement.style.left = '';
    draggedElement.style.top = '';
    draggedElement = null;
  }

  // Correct match handler
  function onCorrectMatch(dragEl, dropEl) {
    dropEl.classList.add('matched');
    dragEl.classList.add('matched');
    dragEl.setAttribute('draggable', 'false');
    dropEl.textContent = ''; // clear Japanese text
    dropEl.appendChild(dragEl);
    pairsMatched++;
    streak++;
    updateProgress();
    updateStreakDisplay();
    animateCorrectMatch(dragEl);
    checkGameComplete();
  }

  // Wrong match handler
  function onWrongMatch(dragEl) {
    streak = 0;
    updateStreakDisplay();
    animateWrongMatch(dragEl);
  }

  // Animate correct match (small sparkle effect)
  function animateCorrectMatch(el) {
    el.classList.add('sparkle');
    setTimeout(() => {
      el.classList.remove('sparkle');
    }, 1200);
  }

  // Animate wrong match (red flash + bounce)
  function animateWrongMatch(el) {
    el.classList.add('flash-red');
    el.classList.add('bounce');
    setTimeout(() => {
      el.classList.remove('flash-red');
      el.classList.remove('bounce');
    }, 600);
  }

  // Check if all pairs matched
  function checkGameComplete() {
    if (pairsMatched === totalPairs) {
      showEndScreen(true);
    }
  }
  // Show end screen
  function showEndScreen(won) {
    confetti.start();
    setTimeout(() => confetti.stop(), 6000);
    gameContainer.style.display = 'none';
    endScreen.style.display = 'block';
    if (won) {
      endTitle.textContent = "🎉 Congratulations! 🎉";
      endSummary.textContent = `You matched all ${totalPairs} pairs!`;
    } else {
      endTitle.textContent = "⏰ Time's Up!";
      endSummary.textContent = `You matched ${pairsMatched} out of ${totalPairs} pairs.`;
    }
    endScore.textContent = `Final Score: ${pairsMatched}`;
  }

  // Restart buttons
  restartBtn.addEventListener('click', () => {
    startGame(lessons.indexOf(currentLesson), challengeMode);
  });

  backToMenuBtn.addEventListener('click', () => {
    endScreen.style.display = 'none';
    startMenu.style.display = 'flex';
    stopChallengeTimer();
  });

  challengeBtn.addEventListener('click', () => {
    startGame(0, true);
  });

  // Challenge mode timer
  const progressContainer = document.getElementById('progress-container');
  function startChallengeTimer() {
    challengeTimeLeft = 120;
    progressContainer.style.display = 'block';
    progressBar.style.backgroundColor = '#e74c3c';
    updateChallengeProgress();
    challengeTimer = setInterval(() => {
      challengeTimeLeft--;
      updateChallengeProgress();
      if (challengeTimeLeft <= 0) {
        clearInterval(challengeTimer);
        showEndScreen(false);
      }
    }, 1000);
  }

  function updateChallengeProgress() {
    const percent = (challengeTimeLeft / 120) * 100;
    progressBar.style.width = percent + '%';
  }

  function stopChallengeTimer() {
    if (challengeTimer) {
      clearInterval(challengeTimer);
      challengeTimer = null;
    }
    progressContainer.style.display = 'none';
    progressBar.style.width = '0%';
  }

  // Dark mode toggle
  darkModeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark');
  });

  // Initialize
  setupLessonButtons();
</script>
</body>
</html>
