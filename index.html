<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vocabulary Match Game</title>
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet" />
<style>
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Comic Neue', cursive, sans-serif;
    margin: 0; padding: 0;
    background: #fefefe;
    color: #333;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  h1.title {
    font-size: 2.6rem;
    text-align: center;
    margin: 1rem 0 1.5rem;
  }
  button {
    font-size: 1.15rem;
    padding: 0.7rem 1.5rem;
    margin: 0.25rem;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background: #ffccdd;
    color: #600026;
    font-weight: 600;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
    transition: background-color 0.25s ease, transform 0.2s ease;
  }
  button:hover, button:focus {
    background: #ffb6ce;
    outline: none;
    transform: scale(1.05);
  }
  #start-menu {
    max-width: 600px;
    margin: auto;
    padding: 1rem 1.5rem 2rem;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.6rem 1rem;
  }
  #start-menu button {
    flex: 1 1 120px;
    max-width: 140px;
    text-align: center;
  }

  /* Game Screen */
  #game-screen {
    display: none;
    max-width: 900px;
    margin: 1rem auto 2rem;
    padding: 0 1rem;
  }
  #game-screen h2 {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 1rem;
  }

  /* Grid container for pairs - 4 columns */
  #pairs-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem 1.5rem;
    max-width: 900px;
    margin: auto;
  }

  /* Each word box */
  .english-word, .japanese-word {
    font-size: 1.25rem;
    background: #f8f8ff;
    border: 2px solid #ccc;
    border-radius: 10px;
    padding: 12px 15px;
    text-align: center;
    user-select: none;
    box-shadow: 0 3px 6px rgb(0 0 0 / 0.06);
    position: relative;
  }
  .english-word {
    cursor: grab;
    background: #ffe0f0;
    border-color: #f4a1c4;
  }
  .english-word.dragging {
    cursor: grabbing;
    opacity: 0.7;
    box-shadow: 0 8px 15px rgb(0 0 0 / 0.2);
  }
  .japanese-word.droppable {
    border-style: dashed;
    background: #f0f0f8;
    border-color: #999;
  }
  .matched {
    background-color: #c1f0c1 !important;
    border-color: #3e903e !important;
    cursor: default !important;
  }

  .bounce-red {
    animation: bounceRed 0.5s ease forwards;
  }
  @keyframes bounceRed {
    0% { transform: translateY(0) scale(1); border-color: #cc0000; background-color: #ffc0c0; }
    50% { transform: translateY(-15px) scale(1.05); border-color: #ff0000; background-color: #ffb0b0; }
    100% { transform: translateY(0) scale(1); border-color: #cc0000; background-color: #ffc0c0; }
  }

  #confetti-canvas {
    position: fixed;
    pointer-events: none;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 10000;
  }

  #progress-container {
    max-width: 700px;
    margin: 15px auto 10px;
    background: #eee;
    border-radius: 20px;
    overflow: hidden;
    height: 18px;
    box-shadow: inset 0 2px 5px rgb(0 0 0 / 0.1);
  }
  #progress-bar {
    height: 100%;
    background: #ff8dcf;
    width: 0%;
    transition: width 0.3s ease;
  }

  #streak-counter {
    text-align: center;
    font-weight: 700;
    font-size: 1.2rem;
    margin-top: 10px;
    color: #d44a87;
    user-select: none;
    position: relative;
  }
  #streak-counter.sparkle {
    animation: sparkle 1.2s ease infinite;
  }
  @keyframes sparkle {
    0%, 100% { text-shadow: 0 0 5px #ff66cc, 0 0 10px #ff66cc, 0 0 15px #ff66cc; }
    50% { text-shadow: 0 0 15px #ff0088, 0 0 25px #ff0088, 0 0 35px #ff0088; }
  }

  #review-screen {
    display: none;
    max-width: 700px;
    margin: auto;
    padding: 1rem 1rem 2rem;
  }
  #review-screen h3 {
    text-align: center;
    font-size: 1.8rem;
    margin-bottom: 1rem;
  }
  #review-list {
    list-style: none;
    padding: 0;
    margin: 0 auto;
    max-width: 480px;
  }
  #review-list li {
    background: #ffe0f0;
    border-radius: 8px;
    margin: 6px 0;
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.2rem;
    cursor: pointer;
  }
  #review-list li.incorrect {
    background: #ffdede;
    border-color: #cc0000;
  }
  #review-list li button {
    background: #d44a87;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
  }
  #review-list li button:hover {
    background: #ff66cc;
  }

  body.dark {
    background: #1a1a2e;
    color: #ddd;
  }
  body.dark button {
    background: #55194a;
    color: #f8c6e0;
    box-shadow: 0 2px 5px rgb(255 255 255 / 0.15);
  }
  body.dark button:hover {
    background: #7a2572;
  }
  body.dark .english-word {
    background: #33184f;
    border-color: #55194a;
    color: #f8c6e0;
  }
  body.dark .japanese-word.droppable {
    background: #22223b;
    border-color: #6f42c1;
    color: #dcd6f7;
  }
  body.dark .matched {
    background-color: #2a7f2a !important;
    border-color: #66bb66 !important;
    color: #defade !important;
  }
  body.dark #progress-container {
    background: #333;
    box-shadow: inset 0 2px 5px rgb(255 255 255 / 0.1);
  }
  body.dark #progress-bar {
    background: #e061cc;
  }
  body.dark #streak-counter {
    color: #e061cc;
  }
  body.dark #review-list li {
    background: #55194a;
    color: #f8c6e0;
  }
  body.dark #review-list li.incorrect {
    background: #772133;
  }
  body.dark #review-list li button {
    background: #e061cc;
  }
  body.dark #review-list li button:hover {
    background: #ff66cc;
  }
</style>
</head>
<body>
  <div id="start-menu">
    <h1 class="title">Vocabulary Match Game</h1>
  </div>

  <div id="game-screen" aria-live="polite" aria-atomic="true">
    <h2 id="game-title"></h2>
    <div id="progress-container" aria-label="Progress of matched pairs">
      <div id="progress-bar"></div>
    </div>
    <div id="streak-counter" aria-live="polite" aria-atomic="true"></div>
    <div id="pairs-container"></div>
    <div style="text-align:center; margin-top: 1rem;">
      <button id="btn-review" style="display:none;">Review Answers</button>
      <button id="btn-back" style="margin-left: 15px;">Back to Menu</button>
    </div>
  </div>

  <div id="review-screen" style="display:none;">
    <h3>Review Your Answers</h3>
    <ul id="review-list" tabindex="0"></ul>
    <div style="text-align:center; margin-top: 1rem;">
      <button id="btn-back-from-review">Back to Menu</button>
    </div>
  </div>

  <canvas id="confetti-canvas"></canvas>

<script>
(() => {
  // Data: only first two lessons shown here; add all as needed
  const lessons = [
    {
      name: "Lesson 1",
      words: [
        {english:"minute", japanese:"分"},
        {english:"before", japanese:"の前に"},
        {english:"photography", japanese:"写真撮影"},
        {english:"tournament", japanese:"トーナメント"},
        {english:"against", japanese:"に対抗して"},
        {english:"lost", japanese:"負けった"},
        {english:"lose", japanese:"負ける"},
        {english:"final", japanese:"最後の"},
        {english:"second", japanese:"秒"},
        {english:"broke", japanese:"壊した"},
        {english:"surely", japanese:"確かに"},
        {english:"until", japanese:"。。。まで"},
        {english:"half", japanese:"半分の"},
        {english:"hour", japanese:"１時間"},
        {english:"tomorrow", japanese:"明日"},
        {english:"today", japanese:"今日"},
        {english:"yesterday", japanese:"昨日"},
        {english:"ago", japanese:"～前に"},
        {english:"spread", japanese:"広める"},
        {english:"stadium", japanese:"スタジアム"}
      ]
    },
    {
      name: "Lesson 2",
      words: [
        {english:"delicious", japanese:"おいしい"},
        {english:"happy", japanese:"幸せ"},
        {english:"run", japanese:"走る"},
        {english:"draw", japanese:"描く"},
        {english:"build", japanese:"建てる"},
        {english:"carry", japanese:"運ぶ"},
        {english:"open", japanese:"開ける"},
        {english:"close", japanese:"閉じる"},
        {english:"wake up", japanese:"目を覚ます"},
        {english:"sleep", japanese:"眠る"},
        {english:"stand", japanese:"立つ"},
        {english:"sit", japanese:"座る"},
        {english:"jump", japanese:"跳ぶ"},
        {english:"swim", japanese:"泳ぐ"},
        {english:"drive", japanese:"運転する"},
        {english:"listen", japanese:"聞く"},
        {english:"write", japanese:"書く"},
        {english:"read", japanese:"読む"},
        {english:"speak", japanese:"話す"},
        {english:"learn", japanese:"学ぶ"}
      ]
    }
  ];

  // Elements
  const startMenu = document.getElementById('start-menu');
  const gameScreen = document.getElementById('game-screen');
  const gameTitle = document.getElementById('game-title');
  const pairsContainer = document.getElementById('pairs-container');
  const progressBar = document.getElementById('progress-bar');
  const streakCounter = document.getElementById('streak-counter');
  const btnReview = document.getElementById('btn-review');
  const btnBack = document.getElementById('btn-back');
  const reviewScreen = document.getElementById('review-screen');
  const reviewList = document.getElementById('review-list');
  const btnBackFromReview = document.getElementById('btn-back-from-review');
  const confettiCanvas = document.getElementById('confetti-canvas');
  let matchedPairs = new Set();
  let matchedCount = 0;
  let totalPairs = 0;
  let streak = 0;
  let incorrectAttempts = [];
  let currentLessonIndex = null;
  let touchDraggingElem = null;

  // Create lesson buttons dynamically 1-14 + dark mode toggle
  function initStartMenu() {
    startMenu.innerHTML = `<h1 class="title">Vocabulary Match Game</h1>`;
    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.flexWrap = 'wrap';
    container.style.justifyContent = 'center';
    container.style.gap = '0.6rem 1rem';
    container.style.maxWidth = '600px';
    container.style.margin = 'auto';
    container.style.padding = '0 1rem 2rem';

    for (let i = 0; i < 14; i++) {
      const btn = document.createElement('button');
      btn.textContent = `Lesson ${i + 1}`;
      btn.onclick = () => startGame(i);
      container.appendChild(btn);
    }

    // Dark mode toggle
    const darkModeBtn = document.createElement('button');
    darkModeBtn.textContent = '🌓 Toggle Dark Mode';
    darkModeBtn.onclick = toggleDarkMode;
    container.appendChild(darkModeBtn);

    startMenu.appendChild(container);
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark');
  }

  function shuffleArray(arr) {
    for (let i=arr.length-1; i>0; i--) {
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // Render 4-column grid: 2 English in col 1 & 3, 2 Japanese in col 2 & 4
  function renderPairs(words) {
    pairsContainer.innerHTML = '';
    // Shuffle English & Japanese separately
    const englishWords = shuffleArray(words.map(w => ({...w})));
    const japaneseWords = shuffleArray(words.map(w => ({...w})));

    // We'll split English words into two groups, Japanese words into two groups
    // For example, first half English in col 1, second half in col 3
    // Same for Japanese: first half in col 2, second half in col 4

    const half = Math.ceil(words.length / 2);

    // English group 1 - col 1
    for (let i=0; i<half; i++) {
      const eng = englishWords[i];
      const engDiv = document.createElement('div');
      engDiv.className = 'english-word draggable';
      engDiv.textContent = eng.english;
      engDiv.dataset.word = eng.english;
      engDiv.setAttribute('draggable', 'true');
      engDiv.style.gridColumn = '1';
      pairsContainer.appendChild(engDiv);
      addDragTouchListeners(engDiv);
    }
    // English group 2 - col 3
    for (let i=half; i<words.length; i++) {
      const eng = englishWords[i];
      const engDiv = document.createElement('div');
      engDiv.className = 'english-word draggable';
      engDiv.textContent = eng.english;
      engDiv.dataset.word = eng.english;
      engDiv.setAttribute('draggable', 'true');
      engDiv.style.gridColumn = '3';
      pairsContainer.appendChild(engDiv);
      addDragTouchListeners(engDiv);
    }
    // Japanese group 1 - col 2
    for (let i=0; i<half; i++) {
      const jap = japaneseWords[i];
      const japDiv = document.createElement('div');
      japDiv.className = 'japanese-word droppable';
      japDiv.textContent = jap.japanese;
      japDiv.dataset.match = jap.english;
      japDiv.style.gridColumn = '2';
      pairsContainer.appendChild(japDiv);
      addDropListeners(japDiv);
    }
    // Japanese group 2 - col 4
    for (let i=half; i<words.length; i++) {
      const jap = japaneseWords[i];
      const japDiv = document.createElement('div');
      japDiv.className = 'japanese-word droppable';
      japDiv.textContent = jap.japanese;
      japDiv.dataset.match = jap.english;
      japDiv.style.gridColumn = '4';
      pairsContainer.appendChild(japDiv);
      addDropListeners(japDiv);
    }
  }

  // Drag & Drop Handlers
  let draggedElem = null;

  function addDragTouchListeners(elem) {
    elem.addEventListener('dragstart', dragStart);
    elem.addEventListener('dragend', dragEnd);
    elem.addEventListener('touchstart', touchStart, {passive:false});
  }
  function addDropListeners(elem) {
    elem.addEventListener('dragover', e => e.preventDefault());
    elem.addEventListener('drop', handleDrop);
  }

  function dragStart(e) {
    draggedElem = e.target;
    e.dataTransfer.setData('text/plain', draggedElem.dataset.word);
    setTimeout(() => {
      draggedElem.classList.add('dragging');
    }, 0);
  }
  function dragEnd(e) {
    if (draggedElem) draggedElem.classList.remove('dragging');
    draggedElem = null;
  }
  function handleDrop(e) {
    e.preventDefault();
    if (!draggedElem) return;
    const dropTarget = e.currentTarget;
    if (dropTarget.dataset.match === draggedElem.dataset.word) {
      markMatched(draggedElem, dropTarget);
    } else {
      wrongDropFeedback(draggedElem);
    }
  }

  // Touch Handlers
  let touchStartX, touchStartY;
  let origX, origY;

  function touchStart(e) {
    e.preventDefault();
    if (touchDraggingElem) return; // Only one drag at a time
    touchDraggingElem = e.target;
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    const rect = touchDraggingElem.getBoundingClientRect();
    origX = rect.left;
    origY = rect.top;
    touchDraggingElem.style.position = 'fixed';
    touchDraggingElem.style.zIndex = '9999';
    touchDraggingElem.style.width = `${rect.width}px`;
    touchDraggingElem.style.height = `${rect.height}px`;
    touchDraggingElem.style.left = `${origX}px`;
    touchDraggingElem.style.top = `${origY}px`;

    playAudio(touchDraggingElem.dataset.word);

    window.addEventListener('touchmove', touchMove, {passive:false});
    window.addEventListener('touchend', touchEnd);
  }
  function touchMove(e) {
    e.preventDefault();
    if (!touchDraggingElem) return;
    const touch = e.touches[0];
    const left = touch.clientX - touchDraggingElem.offsetWidth / 2;
    const top = touch.clientY - touchDraggingElem.offsetHeight / 2;
    touchDraggingElem.style.left = `${left}px`;
    touchDraggingElem.style.top = `${top}px`;
  }
  function touchEnd(e) {
    e.preventDefault();
    if (!touchDraggingElem) return;
    const touch = e.changedTouches[0];
    let elem = document.elementFromPoint(touch.clientX, touch.clientY);
    if (!elem) {
      resetTouchDrag();
      return;
    }
    // Walk up until droppable found
    let dropTarget = elem;
    while (dropTarget && !dropTarget.classList.contains('droppable')) {
      dropTarget = dropTarget.parentElement;
    }
    if (dropTarget && dropTarget.dataset.match === touchDraggingElem.dataset.word) {
      markMatched(touchDraggingElem, dropTarget);
      resetTouchDrag();
    } else {
      wrongDropFeedback(touchDraggingElem);
      resetTouchDrag();
    }
  }
  function resetTouchDrag() {
    if (!touchDraggingElem) return;
    touchDraggingElem.style.position = '';
    touchDraggingElem.style.zIndex = '';
    touchDraggingElem.style.left = '';
    touchDraggingElem.style.top = '';
    touchDraggingElem.style.width = '';
    touchDraggingElem.style.height = '';
    touchDraggingElem = null;
    window.removeEventListener('touchmove', touchMove);
    window.removeEventListener('touchend', touchEnd);
  }

  // Mark matched pair
  function markMatched(engElem, japElem) {
    if (matchedPairs.has(engElem.dataset.word)) return;
    matchedPairs.add(engElem.dataset.word);

    japElem.classList.add('matched');
    engElem.classList.add('matched');
    engElem.setAttribute('draggable', 'false');
    engElem.style.cursor = 'default';

    matchedCount++;
    streak++;
    updateProgress();
    updateStreak();
    showConfettiAt(japElem);

    if (matchedCount === totalPairs) {
      btnReview.style.display = 'inline-block';
    }
  }

  // Bounce and flash red on wrong drop
  function wrongDropFeedback(elem) {
    streak = 0;
    updateStreak();
    elem.classList.add('bounce-red');
    setTimeout(() => elem.classList.remove('bounce-red'), 600);
    incorrectAttempts.push(elem.dataset.word);
    if (touchDraggingElem === elem) resetTouchDrag();
  }

  // Update progress bar
  function updateProgress() {
    const percent = (matchedCount / totalPairs) * 100;
    progressBar.style.width = `${percent}%`;
  }
  // Update streak counter with sparkle
  function updateStreak() {
    if (streak >= 3) {
      streakCounter.textContent = `🔥 Streak: ${streak} 🔥`;
      streakCounter.classList.add('sparkle');
    } else {
      streakCounter.textContent = '';
      streakCounter.classList.remove('sparkle');
    }
  }

  // Play audio with speech synthesis
  function playAudio(word) {
    if (!window.speechSynthesis) return;
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(word);
    utter.lang = 'en-US';
    speechSynthesis.speak(utter);
  }

  // Confetti animation code omitted here for brevity; included in full code below
  const confettiCtx = confettiCanvas.getContext('2d');
  let confettiParticles = [];
  let confettiAnimationId = null;

  function ConfettiParticle(x, y) {
    this.x = x;
    this.y = y;
    this.size = Math.random() * 6 + 4;
    this.speedX = (Math.random() - 0.5) * 5;
    this.speedY = Math.random() * -7 - 3;
    this.gravity = 0.3;
    this.rotation = Math.random() * 360;
    this.rotationSpeed = (Math.random() - 0.5) * 10;
    this.color = `hsl(${Math.random() * 360}, 70%, 60%)`;
    this.opacity = 1;
  }
  ConfettiParticle.prototype.update = function() {
    this.x += this.speedX;
    this.y += this.speedY;
    this.speedY += this.gravity;
    this.rotation += this.rotationSpeed;
    this.opacity -= 0.02;
  }
  ConfettiParticle.prototype.draw = function(ctx) {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate((this.rotation * Math.PI) / 180);
    ctx.fillStyle = this.color;
    ctx.globalAlpha = this.opacity;
    ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
    ctx.restore();
  }
  function createConfetti(x, y) {
    for (let i=0; i<30; i++) {
      confettiParticles.push(new ConfettiParticle(x, y));
    }
    if (!confettiAnimationId) {
      confettiAnimationId = requestAnimationFrame(confettiLoop);
    }
  }
  function confettiLoop() {
    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    confettiParticles.forEach((p, i) => {
      p.update();
      p.draw(confettiCtx);
      if (p.opacity <= 0) confettiParticles.splice(i, 1);
    });
    if (confettiParticles.length > 0) {
      confettiAnimationId = requestAnimationFrame(confettiLoop);
    } else {
      cancelAnimationFrame(confettiAnimationId);
      confettiAnimationId = null;
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    }
  }
  function showConfettiAt(elem) {
    const rect = elem.getBoundingClientRect();
    const x = rect.left + rect.width / 2;
    const y = rect.top + rect.height / 2;
    createConfetti(x, y);
  }

  // Start game
  function startGame(lessonIndex) {
    currentLessonIndex = lessonIndex;
    matchedPairs.clear();
    matchedCount = 0;
    streak = 0;
    incorrectAttempts = [];
    updateProgress();
    updateStreak();
    btnReview.style.display = 'none';

    startMenu.style.display = 'none';
    reviewScreen.style.display = 'none';
    gameScreen.style.display = 'block';

    gameTitle.textContent = `${lessons[lessonIndex].name} - Match the words`;
    const words = lessons[lessonIndex].words;
    totalPairs = words.length;
    renderPairs(words);
    window.scrollTo(0, 0);
  }

  // Review screen
  function showReview() {
    gameScreen.style.display = 'none';
    reviewScreen.style.display = 'block';
    reviewList.innerHTML = '';

    // Matched words first
    matchedPairs.forEach(word => {
      const pair = lessons[currentLessonIndex].words.find(w => w.english === word);
      if (!pair) return;
      const li = document.createElement('li');
      li.textContent = `${pair.english} - ${pair.japanese}`;
      const btn = document.createElement('button');
      btn.textContent = '🔊';
      btn.title = 'Play English word audio';
      btn.onclick = () => playAudio(pair.english);
      li.appendChild(btn);
      reviewList.appendChild(li);
    });

    // Incorrect attempts unique
    [...new Set(incorrectAttempts)].forEach(word => {
      const pair = lessons[currentLessonIndex].words.find(w => w.english === word);
      if (!pair) return;
      const li = document.createElement('li');
      li.textContent = `${pair.english} - ${pair.japanese}`;
      li.classList.add('incorrect');
      const btn = document.createElement('button');
      btn.textContent = '🔊';
      btn.title = 'Play English word audio';
      btn.onclick = () => playAudio(pair.english);
      li.appendChild(btn);
      reviewList.appendChild(li);
    });
  }

  // Event listeners
  btnReview.addEventListener('click', showReview);
  btnBack.addEventListener('click', () => {
    gameScreen.style.display = 'none';
    startMenu.style.display = 'block';
  });
  btnBackFromReview.addEventListener('click', () => {
    reviewScreen.style.display = 'none';
    startMenu.style.display = 'block';
  });

  // Resize confetti canvas
  function resizeCanvas() {
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  // Init
  initStartMenu();

})();
</script>

</body>
</html>
