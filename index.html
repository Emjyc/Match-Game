<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vocabulary Quiz Game</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Nico+Moji&display=swap" rel="stylesheet" />

<!-- Confetti library -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
  /* CSS Variables for Light & Dark Modes */
  :root {
    --bg-color: #f5f7f6;
    --text-color: #334d4d;
    --primary-color: #4a7c74;
    --primary-dark: #2e5d54;
    --secondary-color: #d6e3e1;
    --button-bg: #4a7c74;
    --button-hover: #2e5d54;
    --correct-color: #a8d5a3;
    --incorrect-color: #e57373;
    --progress-bg: #cbd9d7;
    --progress-fill: #4a7c74;
    --progress-warning: #db9242;
    --input-border: #a2b3b0;
    --shadow-color: rgba(0,0,0,0.1);
    --coin-gradient-start: #ffd963;
    --coin-gradient-end: #b8860b;
    --timer-color: var(--primary-dark);
  }
  /* Dark mode overrides */
  [data-theme="dark"] {
    --bg-color: #263238;
    --text-color: #cfd8dc;
    --primary-color: #80cbc4;
    --primary-dark: #4f9a94;
    --secondary-color: #37474f;
    --button-bg: #80cbc4;
    --button-hover: #4f9a94;
    --correct-color: #a5d6a7;
    --incorrect-color: #ef9a9a;
    --progress-bg: #455a64;
    --progress-fill: #80cbc4;
    --progress-warning: #ffb74d;
    --input-border: #78909c;
    --shadow-color: rgba(0,0,0,0.4);
    --coin-gradient-start: #ffe082;
    --coin-gradient-end: #c79200;
    --timer-color: #80cbc4;
  }

  /* Base styles */
  * { box-sizing: border-box; }
  body {
    font-family: 'Comic Neue', cursive;
    background-color: var(--bg-color);
    color: var(--text-color);
    margin: 0; padding: 1rem;
    text-align: center;
    user-select: none;
    transition: background-color 0.4s, color 0.4s;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;

    /* subtle pattern background */
    background-image:
      radial-gradient(circle at 0 0, rgba(0,0,0,0.03) 1px, transparent 1px),
      radial-gradient(circle at 10px 10px, rgba(0,0,0,0.03) 1px, transparent 1px);
    background-size: 20px 20px;
  }
  h1 {
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--primary-dark);
  }
  h2 {
    font-family: 'Nico Moji', monospace;
    margin-top: 1.5rem;
    font-size: 2rem;
  }
  button {
    font-family: 'Comic Neue', cursive;
    background-color: var(--button-bg);
    border: none;
    border-radius: 10px;
    color: white;
    padding: 0.7rem 1.4rem;
    margin: 0.3rem;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 2px 8px var(--shadow-color);
    transition:
      background-color 0.3s ease,
      transform 0.2s ease,
      box-shadow 0.3s ease;
    user-select: none;
  }
  button:hover:not(:disabled) {
    background-color: var(--button-hover);
    transform: scale(1.08);
    box-shadow: 0 6px 14px var(--shadow-color);
  }
  button:disabled {
    opacity: 0.6;
    cursor: default;
  }
  input[type="text"] {
    font-family: 'Comic Neue', cursive;
    padding: 0.5rem;
    width: 80%;
    max-width: 320px;
    font-size: 1.1rem;
    margin-top: 1rem;
    border-radius: 10px;
    border: 2px solid var(--input-border);
    outline-offset: 2px;
    transition: border-color 0.3s ease;
  }
  input[type="text"]:focus {
    border-color: var(--primary-color);
  }

  /* Start Screen */
  .start-screen {
    max-width: 640px;
    margin: 0 auto 2rem;
    padding: 1rem 1.2rem;
    background: var(--secondary-color);
    border-radius: 12px;
    box-shadow: 0 4px 14px var(--shadow-color);
  }
  .set-buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.6rem;
    margin-top: 1rem;
  }
  /* Cute font for set buttons */
  .set-buttons button {
    font-family: 'Comic Neue', cursive;
    font-weight: 700;
    font-size: 1.05rem;
    background-color: #a8bbc9;
    color: #2c3e50;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  }
  .set-buttons button:hover {
    background-color: #7a93a1;
    color: white;
  }

  /* Dark mode toggle */
  #dark-mode-toggle {
    margin-top: 1rem;
    cursor: pointer;
    background: none;
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
    padding: 0.4rem 0.8rem;
    border-radius: 8px;
    font-size: 0.95rem;
    user-select: none;
    transition: background-color 0.3s, color 0.3s, transform 0.2s;
  }
  #dark-mode-toggle:hover {
    background-color: var(--primary-color);
    color: white;
    transform: scale(1.1);
  }

  /* Game Screen */
  .game-screen {
    max-width: 640px;
    margin: 0 auto;
    background: var(--secondary-color);
    border-radius: 12px;
    box-shadow: 0 6px 18px var(--shadow-color);
    padding: 1.5rem 1.8rem;
    position: relative;
  }
  #progress-container {
    width: 100%;
    height: 28px;
    background: var(--progress-bg);
    border-radius: 14px;
    overflow: hidden;
    box-shadow: inset 0 0 6px rgba(0,0,0,0.12);
    margin: 0 auto 12px;
  }
  #progress-bar {
    height: 100%;
    width: 100%;
    background-color: var(--progress-fill);
    border-radius: 14px 0 0 14px;
    transition: width 0.6s ease, background-color 0.6s ease;
  }
  #timer {
    font-family: 'Nico Moji', monospace;
    font-weight: 700;
    font-size: 1.6rem;
    margin: 8px 0 18px;
    color: var(--timer-color);
    transition: color 0.3s ease;
  }
  #timer.pulse {
    animation: pulse 1s infinite ease-in-out;
    color: var(--progress-warning);
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  #score-container {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-family: 'Comic Neue', cursive;
    margin-bottom: 1.3rem;
  }
  #money-amount {
    color: #f9a825;
  }
  #piggy-bank {
    width: 70px;
    height: 65px;
    user-select: none;
    transition: transform 0.3s ease;
    filter: drop-shadow(0 1px 1px rgba(0,0,0,0.15));
  }

  /* Options Buttons */
  #options-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.9rem;
  }
  .option-btn {
    background: var(--secondary-color);
    border: 3px solid var(--primary-color);
    border-radius: 12px;
    padding: 0.9rem 1.5rem;
    font-size: 1.3rem;
    color: var(--primary-dark);
    cursor: pointer;
    box-shadow: 0 3px 8px var(--shadow-color);
    width: 90%;
    max-width: 420px;
    transition:
      background-color 0.4s ease,
      border-color 0.4s ease,
      box-shadow 0.4s ease,
      transform 0.2s ease;
    user-select: none;
  }
  .option-btn:hover:not(:disabled) {
    background-color: var(--primary-color);
    color: white;
    box-shadow: 0 6px 16px var(--shadow-color);
    transform: scale(1.06);
  }
  .option-btn.correct {
    background-color: var(--correct-color);
    border-color: #2e7d32;
    color: #2e7d32;
    cursor: default;
  }
  .option-btn.incorrect {
    animation: shake 0.5s;
    background-color: var(--incorrect-color);
    border-color: #b71c1c;
    color: white;
    cursor: default;
  }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-8px); }
    40%, 80% { transform: translateX(8px); }
  }

  /* Fade animations for question changes */
  .fade-out {
    animation: fadeOut 0.5s forwards;
  }
  .fade-in {
    animation: fadeIn 0.5s forwards;
  }
  @keyframes fadeOut {
    from {opacity: 1;}
    to {opacity: 0;}
  }
  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }

  /* Coin styling and animation */
  .coin {
    position: fixed;
    width: 26px;
    height: 26px;
    background: radial-gradient(circle at 13px 13px, var(--coin-gradient-start) 0%, var(--coin-gradient-end) 100%);
    border-radius: 50%;
    box-shadow: inset 0 0 8px #fff700;
    pointer-events: none;
    animation: fallCoin 1s ease forwards;
    z-index: 9999;
    filter: drop-shadow(0 0 3px rgba(0,0,0,0.15));
  }
  @keyframes fallCoin {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    80% { opacity: 1; }
    100% { transform: translateY(140px) scale(0.3); opacity: 0; }
  }
</style>
</head>
<body>

  <!-- Start Screen -->
  <section class="start-screen" id="start-screen" role="main" aria-label="Start screen">
    <h1>Vocabulary Quiz Game</h1>
    <input type="text" id="player-name" placeholder="Enter your name..." autocomplete="off" aria-label="Enter your name" />
    <div class="set-buttons" id="set-buttons" aria-label="Vocabulary sets to choose"></div>

    <button id="dark-mode-toggle" aria-pressed="false" aria-label="Toggle dark mode">Toggle Dark Mode</button>

    <div style="margin-top:1.5rem; font-style: italic; color: var(--primary-dark); font-size: 0.95rem;">
      Choose a set and challenge yourself!
    </div>
  </section>

  <!-- Game Screen -->
  <section class="game-screen hidden" id="game-screen" role="main" aria-label="Game screen">
    <div id="progress-container" aria-label="Time remaining">
      <div id="progress-bar"></div>
    </div>
    <div id="timer" aria-live="polite" aria-atomic="true">Time: 05:00</div>
    <div id="score-container" aria-live="polite" aria-atomic="true">
      Money: <span id="money-amount">¥0</span>
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fb/Piggy_bank_icon_pink.svg/64px-Piggy_bank_icon_pink.svg.png" id="piggy-bank" alt="Piggy bank" />
    </div>
    <h2 id="japanese-word" aria-live="polite"></h2>
    <div id="options-container"></div>
  </section>

<script>
  // Full vocabulary sets
  const vocabSets = {
    1: [
      {english:"minute", japanese:"分"},
      {english:"before", japanese:"の前に"},
      {english:"photography", japanese:"写真撮影"},
      {english:"tournament", japanese:"トーナメント"},
      {english:"against", japanese:"に対抗して"},
      {english:"lost", japanese:"負けった"},
      {english:"lose", japanese:"負ける"},
      {english:"final", japanese:"最後の"},
      {english:"second", japanese:"秒"},
      {english:"broke", japanese:"壊した"},
      {english:"surely", japanese:"確かに"},
      {english:"until", japanese:"。。。まで"},
      {english:"half", japanese:"半分の"},
      {english:"hour", japanese:"１時間"},
      {english:"tomorrow", japanese:"明日"},
      {english:"today", japanese:"今日"},
      {english:"yesterday", japanese:"昨日"},
      {english:"ago", japanese:"～前に"},
      {english:"spread", japanese:"広める"},
    ],
    2: [
      {english:"if", japanese:"もし"},
      {english:"plastic", japanese:"プラスチック"},
      {english:"exam", japanese:"テスト"},
      {english:"adventure", japanese:"冒険"},
      {english:"read", japanese:"読む"},
      {english:"main", japanese:"主な"},
      {english:"naughty", japanese:"いたずらな"},
      {english:"trouble", japanese:"心配、悩み、やっかいな事態"},
      {english:"lend", japanese:"貸す"},
      {english:"another", japanese:"もう一つの"},
    ],
    3: [
      {english:"think", japanese:"考える・思う"},
      {english:"author", japanese:"作者"},
      {english:"drew", japanese:"描いた"},
      {english:"scenery", japanese:"景色"},
      {english:"in fact", japanese:"今まで"},
      {english:"area", japanese:"地域"},
      {english:"still", japanese:"まだ"},
      {english:"hope", japanese:"望む"},
      {english:"someday", japanese:"いつか"},
      {english:"how", japanese:"どう"},
      {english:"borrow", japanese:"借りる"},
      {english:"fantasy", japanese:"ファンタジー"},
      {english:"message", japanese:"メッセージ"},
      {english:"horror", japanese:"ホラー"},
      {english:"novel", japanese:"小説"},
      {english:"mystery", japanese:"ミステリー"},
      {english:"encourage", japanese:"励ます"},
    ],
    4: [
      {english:"finish", japanese:"終わる"},
      {english:"training", japanese:"トレーニング"},
      {english:"perfect", japanese:"完璧"},
      {english:"learner", japanese:"学習者"},
      {english:"because", japanese:"だから・なので"},
      {english:"easy", japanese:"優しい・簡単な"},
      {english:"plus", japanese:"さらにその上"},
      {english:"teenager", japanese:"１０代の少年"},
      {english:"among", japanese:"の中に・の間に"},
      {english:"ending", japanese:"終わり"},
      {english:"town", japanese:"町"},
      {english:"witch", japanese:"魔女"},
    ],
    5: [
      {english:"famous", japanese:"有名"},
      {english:"dream", japanese:"夢"},
      {english:"build", japanese:"建てる"},
      {english:"tower", japanese:"塔"},
      {english:"around the world", japanese:"世界中"},
      {english:"world", japanese:"世界"},
      {english:"decide", japanese:"決める"},
      {english:"interest", japanese:"興味"},
      {english:"yourself", japanese:"あなた自身"},
      {english:"lots of", japanese:"たくさんの"},
      {english:"bake", japanese:"焼く"},
      {english:"more", japanese:"もっと"},
      {english:"perhaps", japanese:"多分"},
      {english:"bakery", japanese:"パン屋"},
      {english:"need", japanese:"必要"},
    ],
    6: [
      {english:"relax", japanese:"くつろぐ"},
      {english:"customer", japanese:"お客さん"},
      {english:"provide", japanese:"提供する"},
      {english:"several", japanese:"いくつかの"},
      {english:"comfort", japanese:"快適さ"},
      {english:"clothes", japanese:"服"},
      {english:"special", japanese:"特別な"},
      {english:"certain", japanese:"確かな"},
      {english:"recommend", japanese:"勧める"},
      {english:"weekend", japanese:"週末"},
      {english:"price", japanese:"価格"},
      {english:"discovery", japanese:"発見"},
      {english:"space", japanese:"宇宙・空間"},
      {english:"foreign", japanese:"外国の"},
      {english:"adventure", japanese:"冒険"},
      {english:"performance", japanese:"パフォーマンス"},
    ],
    7: [
      {english:"always", japanese:"いつも"},
      {english:"usually", japanese:"たいてい"},
      {english:"sometimes", japanese:"時々"},
      {english:"often", japanese:"よく"},
      {english:"never", japanese:"決して〜ない"},
      {english:"already", japanese:"すでに"},
      {english:"yet", japanese:"まだ"},
      {english:"just", japanese:"ちょうど"},
      {english:"soon", japanese:"すぐに"},
      {english:"still", japanese:"まだ"},
      {english:"ever", japanese:"今までに"},
      {english:"recently", japanese:"最近"},
      {english:"lately", japanese:"最近"},
      {english:"before", japanese:"以前に"},
      {english:"finally", japanese:"ついに"},
    ],
    8: [
      {english:"weather", japanese:"天気"},
      {english:"rain", japanese:"雨"},
      {english:"snow", japanese:"雪"},
      {english:"sunny", japanese:"晴れ"},
      {english:"cloudy", japanese:"曇り"},
      {english:"windy", japanese:"風の強い"},
      {english:"fog", japanese:"霧"},
      {english:"storm", japanese:"嵐"},
      {english:"temperature", japanese:"気温"},
      {english:"forecast", japanese:"予報"},
      {english:"humidity", japanese:"湿度"},
      {english:"thunder", japanese:"雷"},
      {english:"lightning", japanese:"稲妻"},
      {english:"weather report", japanese:"天気予報"},
      {english:"season", japanese:"季節"},
    ],
    9: [
      {english:"family", japanese:"家族"},
      {english:"father", japanese:"お父さん"},
      {english:"mother", japanese:"お母さん"},
      {english:"brother", japanese:"兄弟"},
      {english:"sister", japanese:"姉妹"},
      {english:"grandfather", japanese:"おじいさん"},
      {english:"grandmother", japanese:"おばあさん"},
      {english:"uncle", japanese:"おじ"},
      {english:"aunt", japanese:"おば"},
      {english:"cousin", japanese:"いとこ"},
      {english:"child", japanese:"子供"},
      {english:"parent", japanese:"親"},
      {english:"relative", japanese:"親戚"},
      {english:"baby", japanese:"赤ちゃん"},
      {english:"family reunion", japanese:"家族の集まり"},
    ],
    10: [
      {english:"school", japanese:"学校"},
      {english:"student", japanese:"学生"},
      {english:"teacher", japanese:"先生"},
      {english:"classroom", japanese:"教室"},
      {english:"homework", japanese:"宿題"},
      {english:"exam", japanese:"試験"},
      {english:"library", japanese:"図書館"},
      {english:"lesson", japanese:"授業"},
      {english:"subject", japanese:"科目"},
      {english:"grade", japanese:"成績"},
      {english:"principal", japanese:"校長"},
      {english:"schedule", japanese:"予定"},
      {english:"uniform", japanese:"制服"},
      {english:"break time", japanese:"休み時間"},
      {english:"club activity", japanese:"クラブ活動"},
    ],
    11: [
      {english:"food", japanese:"食べ物"},
      {english:"rice", japanese:"ご飯"},
      {english:"bread", japanese:"パン"},
      {english:"fish", japanese:"魚"},
      {english:"meat", japanese:"肉"},
      {english:"vegetable", japanese:"野菜"},
      {english:"fruit", japanese:"果物"},
      {english:"soup", japanese:"スープ"},
      {english:"dessert", japanese:"デザート"},
      {english:"drink", japanese:"飲み物"},
      {english:"breakfast", japanese:"朝食"},
      {english:"lunch", japanese:"昼食"},
      {english:"dinner", japanese:"夕食"},
      {english:"restaurant", japanese:"レストラン"},
      {english:"menu", japanese:"メニュー"},
    ],
    12: [
      {english:"travel", japanese:"旅行"},
      {english:"airport", japanese:"空港"},
      {english:"ticket", japanese:"切符"},
      {english:"passport", japanese:"パスポート"},
      {english:"hotel", japanese:"ホテル"},
      {english:"luggage", japanese:"荷物"},
      {english:"tour", japanese:"ツアー"},
      {english:"map", japanese:"地図"},
      {english:"guide", japanese:"ガイド"},
      {english:"bus", japanese:"バス"},
      {english:"train", japanese:"電車"},
      {english:"car", japanese:"車"},
      {english:"beach", japanese:"ビーチ"},
      {english:"mountain", japanese:"山"},
      {english:"sightseeing", japanese:"観光"},
    ],
    13: [
      {english:"sports", japanese:"スポーツ"},
      {english:"soccer", japanese:"サッカー"},
      {english:"baseball", japanese:"野球"},
      {english:"tennis", japanese:"テニス"},
      {english:"basketball", japanese:"バスケットボール"},
      {english:"swimming", japanese:"水泳"},
      {english:"running", japanese:"走ること"},
      {english:"volleyball", japanese:"バレーボール"},
      {english:"coach", japanese:"コーチ"},
      {english:"team", japanese:"チーム"},
      {english:"match", japanese:"試合"},
      {english:"goal", japanese:"ゴール"},
      {english:"winner", japanese:"勝者"},
      {english:"loser", japanese:"敗者"},
      {english:"tournament", japanese:"トーナメント"},
    ],
    14: [
      {english:"music", japanese:"音楽"},
      {english:"song", japanese:"歌"},
      {english:"piano", japanese:"ピアノ"},
      {english:"guitar", japanese:"ギター"},
      {english:"drum", japanese:"ドラム"},
      {english:"dance", japanese:"踊り"},
      {english:"concert", japanese:"コンサート"},
      {english:"band", japanese:"バンド"},
      {english:"singer", japanese:"歌手"},
      {english:"voice", japanese:"声"},
      {english:"melody", japanese:"メロディー"},
      {english:"rhythm", japanese:"リズム"},
      {english:"instrument", japanese:"楽器"},
      {english:"performance", japanese:"演奏"},
      {english:"listen", japanese:"聞く"},
    ],
    15: [
      {english:"environment", japanese:"環境"},
      {english:"recycle", japanese:"リサイクル"},
      {english:"pollution", japanese:"汚染"},
      {english:"nature", japanese:"自然"},
      {english:"forest", japanese:"森"},
      {english:"river", japanese:"川"},
      {english:"animal", japanese:"動物"},
      {english:"plant", japanese:"植物"},
      {english:"climate", japanese:"気候"},
      {english:"earth", japanese:"地球"},
      {english:"green", japanese:"緑"},
      {english:"energy", japanese:"エネルギー"},
      {english:"reduce", japanese:"減らす"},
      {english:"waste", japanese:"無駄"},
      {english:"conserve", japanese:"保存する"},
    ],
  };

  // Global game state
  let currentSet = null;
  let questions = [];
  let currentIndex = 0;
  let score = 0;
  let timerInterval = null;
  let timeLeft = 300; // 5 minutes in seconds
  let coinsEarned = 0;

  // DOM references
  const startScreen = document.getElementById('start-screen');
  const gameScreen = document.getElementById('game-screen');
  const setButtonsContainer = document.getElementById('set-buttons');
  const playerNameInput = document.getElementById('player-name');
  const darkModeToggle = document.getElementById('dark-mode-toggle');

  const japaneseWordEl = document.getElementById('japanese-word');
  const optionsContainer = document.getElementById('options-container');
  const progressBar = document.getElementById('progress-bar');
  const timerEl = document.getElementById('timer');
  const moneyAmountEl = document.getElementById('money-amount');
  const piggyBank = document.getElementById('piggy-bank');

  // --- Initialize start screen sets buttons ---
  function createSetButtons() {
    setButtonsContainer.innerHTML = '';
    for (const setNum in vocabSets) {
      const btn = document.createElement('button');
      btn.textContent = `Set ${setNum} (${vocabSets[setNum].length} words)`;
      btn.setAttribute('data-set', setNum);
      btn.addEventListener('click', () => {
        if (!playerNameInput.value.trim()) {
          alert('Please enter your name before starting.');
          playerNameInput.focus();
          return;
        }
        startGame(parseInt(setNum));
      });
      setButtonsContainer.appendChild(btn);
    }
  }

  // --- Dark Mode Toggle ---
  function toggleDarkMode() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (isDark) {
      document.documentElement.removeAttribute('data-theme');
      darkModeToggle.setAttribute('aria-pressed', 'false');
    } else {
      document.documentElement.setAttribute('data-theme', 'dark');
      darkModeToggle.setAttribute('aria-pressed', 'true');
    }
  }
  darkModeToggle.addEventListener('click', toggleDarkMode);

  // --- Start Game ---
  function startGame(setNum) {
    currentSet = setNum;
    score = 0;
    coinsEarned = 0;
    timeLeft = 300;
    moneyAmountEl.textContent = `¥0`;
    startScreen.classList.add('hidden');
    gameScreen.classList.remove('hidden');
    questions = shuffleArray(vocabSets[currentSet].slice());
    currentIndex = 0;
    showQuestion();
    startTimer();
  }

  // --- Timer ---
  function startTimer() {
    updateTimerDisplay();
    progressBar.style.width = '100%';
    progressBar.style.backgroundColor = 'var(--progress-fill)';
    timerEl.classList.remove('pulse');

    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      timeLeft--;
      updateTimerDisplay();
      updateProgressBar();

      if (timeLeft <= 30) {
        timerEl.classList.add('pulse');
        progressBar.style.backgroundColor = 'var(--progress-warning)';
      } else {
        timerEl.classList.remove('pulse');
        progressBar.style.backgroundColor = 'var(--progress-fill)';
      }

      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        endGame();
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const seconds = (timeLeft % 60).toString().padStart(2, '0');
    timerEl.textContent = `Time: ${minutes}:${seconds}`;
  }

  function updateProgressBar() {
    const percent = (timeLeft / 300) * 100;
    progressBar.style.width = `${percent}%`;
  }

  // --- Show Question ---
  function showQuestion() {
    // Fade out old content
    japaneseWordEl.classList.add('fade-out');
    optionsContainer.classList.add('fade-out');
    setTimeout(() => {
      // Clear old options
      optionsContainer.innerHTML = '';

      // Show new Japanese word
      const q = questions[currentIndex];
      japaneseWordEl.textContent = q.japanese;

      // Make 4 options: one correct + 3 random wrong
      const allWords = vocabSets[currentSet];
      let options = [q];
      while (options.length < 4) {
        const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
        if (!options.some(o => o.english === randomWord.english)) options.push(randomWord);
      }
      options = shuffleArray(options);

      options.forEach(option => {
        const btn = document.createElement('button');
        btn.textContent = option.english;
        btn.className = 'option-btn';
        btn.addEventListener('click', () => handleAnswer(btn, option));
        optionsContainer.appendChild(btn);
      });

      // Fade in new content
      japaneseWordEl.classList.remove('fade-out');
      japaneseWordEl.classList.add('fade-in');
      optionsContainer.classList.remove('fade-out');
      optionsContainer.classList.add('fade-in');

      // Remove fade-in after animation to allow next fade out
      setTimeout(() => {
        japaneseWordEl.classList.remove('fade-in');
        optionsContainer.classList.remove('fade-in');
      }, 600);
    }, 500);
  }

  // --- Handle Answer ---
  function handleAnswer(button, selectedOption) {
    if (button.disabled) return;

    const correctAnswer = questions[currentIndex].english;
    if (selectedOption.english === correctAnswer) {
      button.classList.add('correct');
      incrementScore();
      playConfetti();
      coinsEarned++;
      animateCoinToPiggyBank(button);
      disableAllOptions();
      setTimeout(() => {
        nextQuestion();
      }, 1200);
    } else {
      button.classList.add('incorrect');
      shakeButton(button);
      button.disabled = true;
    }
  }

  function disableAllOptions() {
    const buttons = optionsContainer.querySelectorAll('button');
    buttons.forEach(btn => btn.disabled = true);
  }

  // --- Next Question ---
  function nextQuestion() {
    currentIndex++;
    if (currentIndex >= questions.length) {
      endGame();
    } else {
      showQuestion();
    }
  }

  // --- End Game ---
  function endGame() {
    clearInterval(timerInterval);
    alert(`Time's up! ${playerNameInput.value.trim()}, you earned ¥${coinsEarned * 10}!`);
    // Reset screens
    gameScreen.classList.add('hidden');
    startScreen.classList.remove('hidden');
    playerNameInput.value = '';
  }

  // --- Increment Score ---
  function incrementScore() {
    score++;
    moneyAmountEl.textContent = `¥${score * 10}`;
  }

  // --- Utility: Shuffle Array ---
  function shuffleArray(array) {
    let arr = array.slice();
    for (let i = arr.length -1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // --- Confetti on correct ---
  function playConfetti() {
    confetti({
      particleCount: 40,
      spread: 70,
      origin: { y: 0.6 }
    });
  }

  // --- Shake animation ---
  function shakeButton(btn) {
    btn.classList.add('shake');
    setTimeout(() => {
      btn.classList.remove('shake');
    }, 500);
  }

  // --- Animate coin falling into piggy bank ---
  function animateCoinToPiggyBank(originBtn) {
    // Create coin element
    const coin = document.createElement('div');
    coin.className = 'coin';

    // Get origin button position (center top)
    const originRect = originBtn.getBoundingClientRect();
    coin.style.left = `${originRect.left + originRect.width/2 - 13}px`;
    coin.style.top = `${originRect.top}px`;
    document.body.appendChild(coin);

    // Destination (piggy bank slot center)
    const piggyRect = piggyBank.getBoundingClientRect();
    const targetX = piggyRect.left + piggyRect.width/2 - 13;
    const targetY = piggyRect.top + piggyRect.height - 10;

    // Animate with JS: fall down + horizontal drift + scale + fade out
    const duration = 1000; // 1s
    const startTime = performance.now();

    function animate(time) {
      let elapsed = time - startTime;
      if (elapsed > duration) elapsed = duration;

      const progress = elapsed / duration;

      // Linear fall
      const currentY = originRect.top + progress * (targetY - originRect.top);
      // Ease horizontal drift
      const currentX = originRect.left + (targetX - originRect.left) * easeOutCubic(progress);

      // Scale down near end
      const scale = 1 - 0.7 * progress;

      coin.style.transform = `translate(${currentX - (originRect.left + originRect.width/2 - 13)}px, ${currentY - originRect.top}px) scale(${scale})`;
      coin.style.opacity = `${1 - progress}`;

      if (elapsed < duration) {
        requestAnimationFrame(animate);
      } else {
        coin.remove();
      }
    }
    requestAnimationFrame(animate);
  }
  function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
  }

  // --- Initialization ---
  createSetButtons();

</script>
</body>
</html>
