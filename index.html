<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Match the Words! - Multiple Sets</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Nico+Moji&display=swap" rel="stylesheet" />
  <style>
    /* All previous styles unchanged */
    * { box-sizing: border-box; }
    body {
      font-family: 'Comic Neue', cursive;
      margin: 0; padding: 1rem;
      text-align: center;
      color: #333;
      background-color: #f0f0f0;
    }
    h1, h2 {
      color: #00695c;
      margin: 0.5rem 0;
    }
    #subtitle {
      font-size: 1.2rem;
      color: #00796b;
      margin-bottom: 1rem;
    }
    .hidden { display: none; }
    .game-container {
      display: grid;
      grid-template-columns: repeat(6, 1fr); /* Changed from 4 to 6 columns */
      gap: 1rem;
      justify-items: center;
      margin-top: 1rem;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }
    .column {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
    }
    .item {
      width: 160px;
      height: 48px;
      padding: 0.5rem;
      border: 2px solid #00838f;
      background-color: #fff;
      border-radius: 8px;
      cursor: grab;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      position: relative;
      transition: box-shadow 0.3s ease;
    }
    .item[data-lang="en"] {
      font-family: 'Comic Neue', cursive;
      position: relative;
    }
    .item[data-lang="ja"] {
      font-family: 'Nico Moji', sans-serif;
    }
    .item.correct {
      background-color: #c8e6c9;
      border-color: #2e7d32;
      color: #2e7d32;
      cursor: default;
      box-shadow: 0 0 12px 3px #66bb6a;
    }
    .item.incorrect-flash {
      animation: flashRed 0.5s;
      border-color: #c62828 !important;
      background-color: #ffcdd2 !important;
    }
    @keyframes flashRed {
      0%, 100% { background-color: #ffcdd2; border-color: #c62828; }
      50% { background-color: #fff; border-color: #00838f; }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }
    .sparkle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 30px;
      height: 30px;
      pointer-events: none;
      background: radial-gradient(circle at center, #fff8 20%, #00acc1 80%);
      border-radius: 50%;
      opacity: 0;
      animation: sparkle 0.8s forwards;
      transform: translate(-50%, -50%);
      z-index: 10;
    }
    @keyframes sparkle {
      0% {
        opacity: 1;
        transform: scale(0.5) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: scale(2) rotate(360deg);
      }
    }
    #timer {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #c62828;
      text-align: left;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }
    #progress-container {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 250px;
      height: 20px;
      background: #ddd;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: inset 0 0 5px #bbb;
      font-size: 0.8rem;
      color: #004d40;
      font-weight: bold;
      user-select: none;
      z-index: 1000;
    }
    #progress-bar {
      height: 100%;
      background-color: #00796b;
      width: 0%;
      transition: width 0.3s ease;
    }
    button {
      padding: 0.6rem 1.2rem;
      font-size: 0.95rem;
      border: none;
      border-radius: 6px;
      margin-top: 1rem;
      cursor: pointer;
      background-color: #00796b;
      color: white;
      transition: background-color 0.3s;
      font-family: 'Comic Neue', cursive;
    }
    button:hover { background-color: #004d40; }
    #start-screen {
      max-width: 500px;
      margin: 3rem auto 0 auto;
      padding: 1rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px #999;
    }
    #set-buttons {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.6rem;
      margin-top: 1rem;
    }
    #set-buttons button {
      padding: 0.5rem;
      font-size: 0.9rem;
    }
    /* Modal popup styling */
    #modal-overlay {
      position: fixed;
      top: 0; left: 0; right:0; bottom:0;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #modal-overlay.show {
      visibility: visible;
      opacity: 1;
    }
    #modal-box {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 320px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      text-align: center;
      font-family: 'Comic Neue', cursive;
    }
    #modal-box h2 {
      margin-bottom: 1rem;
      color: #00796b;
    }
    #modal-box button {
      background-color: #00796b;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
    }
    #modal-box button:hover {
      background-color: #004d40;
    }
  </style>
</head>
<body>
  <div id="progress-container" class="hidden">
    <div id="progress-bar"></div>
  </div>

  <div id="start-screen">
    <h1>Match the Words!</h1>
    <div id="subtitle">Lesson 4 New Words</div>
    <p>Select a set to start:</p>
    <div id="set-buttons">
      <button data-set="0">Set 1</button>
      <button data-set="1">Set 2</button>
      <button data-set="2">Set 3</button>
      <button data-set="3">Set 4</button>
      <button data-set="4">Set 5</button>
      <button data-set="5">Set 6</button>
      <button data-set="6">Set 7</button>
      <button data-set="7">Set 8</button>
      <button data-set="8">Set 9</button>
    </div>
  </div>

  <div id="timer" class="hidden">Time Left: 5:00</div>

  <div id="game-screen" class="hidden">
    <h2>Match the Words</h2>
    <div class="game-container">
      <div class="column" id="english-col-1"></div>
      <div class="column" id="english-col-2"></div>
      <div class="column" id="english-col-3"></div>  <!-- Added third English column -->
      <div class="column" id="japanese-col-1"></div>
      <div class="column" id="japanese-col-2"></div>
      <div class="column" id="japanese-col-3"></div>  <!-- Added third Japanese column -->
    </div>
    <button id="reset-btn">Reset</button>
  </div>

  <!-- Modal for end game messages -->
  <div id="modal-overlay">
    <div id="modal-box">
      <h2 id="modal-message">Message</h2>
      <button id="modal-close-btn">Close</button>
    </div>
  </div>

   <script>
    const sets = [
      {
        name: "Set 1",
        vocab: [
          { english: "minute", japanese: "åˆ†" },
          { english: "before", japanese: "ã®å‰ã«" },
          { english: "photography", japanese: "å†™çœŸæ’®å½±" },
          { english: "tournament", japanese: "ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ" },
          { english: "article", japanese: "ã«å¯¾æŠ—ã—ã¦" },
          { english: "against", japanese: "ï½žã«å¯¾æŠ—ã—ã¦" },
          { english: "lost", japanese: "è² ã‘ã£ãŸ" },
          { english: "lose", japanese: "è² ã‘ã‚‹" },
          { english: "final", japanese: "æœ€å¾Œã®" },
          { english: "second", japanese: "ç§’" },
          { english: "broke", japanese: "å£Šã—ãŸ" },
          { english: "surely", japanese: "ç¢ºã‹ã«" },
          { english: "half", japanese: "åŠåˆ†ã®" },
          { english: "hour", japanese: "ï¼‘æ™‚é–“" },
          { english: "until", japanese: "ã€‚ã€‚ã€‚ã¾ã§" },
          { english: "spread", japanese: "åºƒã‚ã‚‹" },
          { english: "today", japanese: "ä»Šæ—¥" },
          { english: "tomorrow", japanese: "æ˜Žæ—¥" },
          { english: "yesterday", japanese: "æ˜¨æ—¥" },
          { english: "ago", japanese: "ï½žå‰ã«" },
        ]
      },
      {
        name: "Set 2",
        vocab: [
          { english: "if", japanese: "ã‚‚ã—" },
          { english: "plastic", japanese: "ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯" },
          { english: "exam", japanese: "ãƒ†ã‚¹ãƒˆ" },
          { english: "adventure", japanese: "å†’é™º" },
          { english: "read", japanese: "èª­ã‚€" },
          { english: "main", japanese: "ä¸»ãª" },
          { english: "naughty", japanese: "ã„ãŸãšã‚‰ãª" },
          { english: "trouble", japanese: "å¿ƒé…ã€æ‚©ã¿ã€ã‚„ã£ã‹ã„ãªäº‹æ…‹" },
          { english: "lend", japanese: "è²¸ã™" },
          { english: "another", japanese: "ã‚‚ã†ä¸€ã¤ã®" },
        ]
      },
      {
        name: "Set 3",
        vocab: [
          { english: "think", japanese: "è€ƒãˆã‚‹ãƒ»æ€ã†" },
          { english: "author", japanese: "ä½œè€…" },
          { english: "drew", japanese: "æã„ãŸ" },
          { english: "scenery", japanese: "æ™¯è‰²" },
          { english: "in fact", japanese: "ä»Šã¾ã§" },
          { english: "area", japanese: "åœ°åŸŸ" },
          { english: "still", japanese: "ã¾ã " },
          { english: "hope", japanese: "æœ›ã‚€" },
          { english: "someday", japanese: "ã„ã¤ã‹" },
          { english: "how", japanese: "ã©ã†" },
          { english: "borrow", japanese: "å€Ÿã‚Šã‚‹" },
          { english: "fantasy", japanese: "ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼" },
          { english: "message", japanese: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" },
          { english: "horror", japanese: "ãƒ›ãƒ©ãƒ¼" },
          { english: "novel", japanese: "å°èª¬" },
          { english: "mystery", japanese: "ãƒŸã‚¹ãƒ†ãƒªãƒ¼" },
          { english: "encourage", japanese: "åŠ±ã¾ã™" },
        ]
      },
      {
        name: "Set 4",
        vocab: [
          { english: "finish", japanese: "çµ‚ã‚ã‚‹" },
          { english: "training", japanese: "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°" },
          { english: "perfect", japanese: "å®Œç’§" },
          { english: "learner", japanese: "å­¦ç¿’è€…" },
          { english: "because", japanese: "ã ã‹ã‚‰ãƒ»ãªã®ã§" },
          { english: "easy", japanese: "å„ªã—ã„ãƒ»ç°¡å˜ãª" },
          { english: "plus", japanese: "ã•ã‚‰ã«ãã®ä¸Š" },
          { english: "teenager", japanese: "ï¼‘ï¼ä»£ã®å°‘å¹´" },
          { english: "among", japanese: "ã®ä¸­ã«ãƒ»ã®é–“ã«" },
          { english: "ending", japanese: "çµ‚ã‚ã‚Š" },
          { english: "town", japanese: "ç”º" },
          { english: "witch", japanese: "é­”å¥³" },
        ]
      },
      {
        name: "Set 5",
        vocab: [
          { english: "famous", japanese: "æœ‰å" },
          { english: "dream", japanese: "å¤¢" },
          { english: "build", japanese: "å»ºã¦ã‚‹" },
          { english: "tower", japanese: "å¡”" },
          { english: "around the world", japanese: "ä¸–ç•Œä¸­" },
          { english: "world", japanese: "ä¸–ç•Œ" },
          { english: "decide", japanese: "æ±ºã‚ã‚‹" },
          { english: "interest", japanese: "èˆˆå‘³" },
          { english: "yourself", japanese: "ã‚ãªãŸè‡ªèº«" },
          { english: "lots of", japanese: "ãŸãã•ã‚“ã®" },
          { english: "bake", japanese: "ç„¼ã" },
          { english: "more", japanese: "ã‚‚ã£ã¨" },
          { english: "perhaps", japanese: "ãŠãã‚‰ã" },
          { english: "bakery", japanese: "ãƒ‘ãƒ³å±‹" },
          { english: "need", japanese: "å¿…è¦" },
        ]
      },
      {
        name: "Set 6",
        vocab: [
          { english: "relax", japanese: "ãã¤ã‚ã" },
          { english: "customer", japanese: "ãŠå®¢æ§˜" },
          { english: "provide", japanese: "æä¾›ã™ã‚‹" },
          { english: "several", japanese: "ã„ãã¤ã‹ã®" },
          { english: "that way", japanese: "ãã®ã‚ˆã†ã«ã—ã¦" },
          { english: "plenty", japanese: "ãŸãã•ã‚“ã®" },
          { english: "choice", japanese: "é¸æŠž" },
          { english: "however", japanese: "ã—ã‹ã—" },
          { english: "leftovers", japanese: "æ®‹ã‚Šç‰©ãƒ»é£Ÿã¹æ®‹ã—" },
          { english: "away", japanese: "åˆ¥ã®æ–¹å‘ã¸ãƒ»ã‚ãã¸" },
          { english: "throw away", japanese: "ç„¡é§„ã«ä½¿ã†" },
          { english: "waste", japanese: "ç„¡é§„ã«ä½¿ã†" },
          { english: "discount", japanese: "å‰²å¼•" },
          { english: "enough", japanese: "ååˆ†ãª" },
          { english: "help", japanese: "å½¹ã«ç«‹ã¤ãƒ»åŠ©ã‘ã‚‹" },
        ]
      },
      {
        name: "Set 7",
        vocab: [
          { english: "pool", japanese: "ãƒ—ãƒ¼ãƒ«" },
          { english: "over", japanese: "ï½žã‚’è¶…ãˆã¦" },
          { english: "review", japanese: "è¦‹ç›´ã™" },
          { english: "rule", japanese: "ãƒ«ãƒ¼ãƒ«" },
          { english: "kitchen", japanese: "å°æ‰€" },
          { english: "must", japanese: "ï½žã—ãªã‘ã‚Œã°ãªã‚‰ãªã„" },
          { english: "mask", japanese: "ãƒžã‚¹ã‚¯" },
          { english: "smartphone (phone)", japanese: "ã‚¹ãƒžãƒ›ï¼ˆé›»è©±ï¼‰" },
          { english: "back", japanese: "æˆ»ã‚‹" },
          { english: "return", japanese: "è¿”ã™" },
          { english: "week", japanese: "é€±" },
          { english: "quiet", japanese: "é™ã‹ãª" },
          { english: "future", japanese: "æœªæ¥" },
          { english: "in the future", japanese: "å°†æ¥" },
          { english: "somewhere", japanese: "ã©ã“ã‹" },
          { english: "explore", japanese: "æŽ¢æ¤œã™ã‚‹" },
          { english: "clothes", japanese: "æœ" },
          { english: "design", japanese: "ãƒ‡ã‚¶ã‚¤ãƒ³" },
          { english: "chef", japanese: "æ–™ç†äºº" },
        ]
      },
      {
        name: "Set 8",
        vocab: [
          { english: "as", japanese: "ï½žã¨ã—ã¦" },
          { english: "behind", japanese: "å¾Œã‚" },
          { english: "cut down", japanese: "åˆ‡ã‚Šå€’ã™" },
          { english: "building", japanese: "å»ºç‰©" },
          { english: "destroy", japanese: "ç ´å£Šã™ã‚‹" },
          { english: "shock", japanese: "ã‚·ãƒ§ãƒƒã‚¯" },
          { english: "environment", japanese: "ç’°å¢ƒ" },
          { english: "guide", japanese: "æ¡ˆå†…" },
          { english: "tour", japanese: "ãƒ„ã‚¢ãƒ¼" },
          { english: "simply", japanese: "å˜ã«" },
          { english: "nothing", japanese: "ä½•ã‚‚" },
          { english: "worry", japanese: "å¿ƒé…ã™ã‚‹" },
          { english: "decide", japanese: "æ±ºã‚ã‚‹" },
          { english: "major", japanese: "ä¸»è¦ãª" },
          { english: "less", japanese: "ã‚ˆã‚Šå°‘ãªã„" },
          { english: "sell", japanese: "å£²ã‚‹" },
          { english: "sold", japanese: "å£²ã‚ŒãŸ" },
          { english: "knowledge", japanese: "çŸ¥è­˜" },
          { english: "itself", japanese: "ãã‚Œè‡ªä½“" },
          { english: "share", japanese: "å…±æœ‰ã™ã‚‹" },
        ]
      },
      {
        name: "Set 9",
        vocab: [
          { english: "billion", japanese: "ï¼‘ï¼å„„" },
          { english: "than", japanese: "ã€‚ã€‚ã€‚ã‚ˆã‚Šã‚‚" },
          { english: "more than...", japanese: "ã€‚ã€‚ã€‚ã‚ˆã‚Šå¤šãã®" },
          { english: "dirty", japanese: "æ±šã‚Œã‚‹" },
          { english: "directly", japanese: "ç›´æŽ¥" },
          { english: "pond", japanese: "æ± " },
          { english: "should", japanese: "ã™ã¹ãã§ã‚ã‚‹" },
          { english: "presentation", japanese: "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³" },
          { english: "everywhere", japanese: "ã©ã“ã§ã‚‚" },
          { english: "imagine", japanese: "æƒ³åƒã™ã‚‹" },
          { english: "step", japanese: "ä¸€æ­©" },
          { english: "situation", japanese: "äº‹æ…‹" },
          { english: "one of...", japanese: "ã®ä¸€ã¤ãƒ»ä¸€äºº" },
          { english: "collect", japanese: "å–ã‚Šã«è¡Œã" },
          { english: "drinking water", japanese: "é£²ã¿æ°´" },
          { english: "undertand", japanese: "ç†è§£ã™ã‚‹" },
          { english: "laundry", japanese: "æ´—æ¿¯ç‰©" },
          { english: "available", japanese: "å…¥ã‚Šã¦ã§ãã‚‹" },
          { english: "post", japanese: "éƒµä¾¿" },
          { english: "store", japanese: "åº—" },
          { english: "office", japanese: "äº‹å‹™æ‰€" },
        ]
      }
    ];

    let currentSetIndex = null;
    let matchedCount = 0;
    let totalPairs = 0;
    let timerInterval = null;
    let timeLeft = 300; // 5 minutes in seconds

    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const englishCol1 = document.getElementById('english-col-1');
    const englishCol2 = document.getElementById('english-col-2');
    const englishCol3 = document.getElementById('english-col-3'); // new col
    const japaneseCol1 = document.getElementById('japanese-col-1');
    const japaneseCol2 = document.getElementById('japanese-col-2');
    const japaneseCol3 = document.getElementById('japanese-col-3'); // new col
    const resetBtn = document.getElementById('reset-btn');
    const timerDisplay = document.getElementById('timer');
    const progressBar = document.getElementById('progress-bar');
    const progressContainer = document.getElementById('progress-container');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalMessage = document.getElementById('modal-message');
    const modalCloseBtn = document.getElementById('modal-close-btn');

    // Store original positions for bounce-back
    let dragOrigin = null;
    let dragElement = null;

    // Initialize set buttons
    document.querySelectorAll('#set-buttons button').forEach(btn => {
      btn.addEventListener('click', () => {
        currentSetIndex = parseInt(btn.dataset.set);
        startGame();
      });
    });

    resetBtn.addEventListener('click', () => {
      resetGame();
    });

    modalCloseBtn.addEventListener('click', () => {
      closeModal();
      resetGame();
    });

    // Shuffle utility
    function shuffle(array) {
      for (let i = array.length -1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i+1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function startGame() {
      matchedCount = 0;
      timeLeft = 300;
      progressContainer.classList.remove('hidden');
      timerDisplay.classList.remove('hidden');
      startScreen.classList.add('hidden');
      gameScreen.classList.remove('hidden');

      const set = sets[currentSetIndex];
      document.querySelector('#game-screen h2').textContent = `Match the Words - ${set.name}`;

      totalPairs = set.vocab.length;

      // Clear previous columns
      englishCol1.innerHTML = '';
      englishCol2.innerHTML = '';
      englishCol3.innerHTML = '';
      japaneseCol1.innerHTML = '';
      japaneseCol2.innerHTML = '';
      japaneseCol3.innerHTML = '';
      progressBar.style.width = '0%';

      // Shuffle english and japanese separately
      const englishWords = shuffle([...set.vocab]);
      const japaneseWords = shuffle([...set.vocab]);

      // Split english and japanese into three columns
      const thirdE = Math.ceil(englishWords.length / 3);
      const engCol1Items = englishWords.slice(0, thirdE);
      const engCol2Items = englishWords.slice(thirdE, 2*thirdE);
      const engCol3Items = englishWords.slice(2*thirdE);

      const thirdJ = Math.ceil(japaneseWords.length / 3);
      const japCol1Items = japaneseWords.slice(0, thirdJ);
      const japCol2Items = japaneseWords.slice(thirdJ, 2*thirdJ);
      const japCol3Items = japaneseWords.slice(2*thirdJ);

      // Create English draggable items
      engCol1Items.forEach(item => {
        const div = createDraggableEnglish(item);
        englishCol1.appendChild(div);
      });
      engCol2Items.forEach(item => {
        const div = createDraggableEnglish(item);
        englishCol2.appendChild(div);
      });
      engCol3Items.forEach(item => {
        const div = createDraggableEnglish(item);
        englishCol3.appendChild(div);
      });

      // Create Japanese drop targets
      japCol1Items.forEach(item => {
        const div = createDropTargetJapanese(item);
        japaneseCol1.appendChild(div);
      });
      japCol2Items.forEach(item => {
        const div = createDropTargetJapanese(item);
        japaneseCol2.appendChild(div);
      });
      japCol3Items.forEach(item => {
        const div = createDropTargetJapanese(item);
        japaneseCol3.appendChild(div);
      });

      updateTimerDisplay();
      startTimer();
    }
    function createDraggableEnglish(item) {
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.lang = 'en';
      div.textContent = item.english;
      div.draggable = true;
      div.dataset.english = item.english;
      div.dataset.japanese = item.japanese;

      div.id = `eng-${item.english.replace(/\s+/g,'-').toLowerCase()}`;

      div.addEventListener('dragstart', e => {
        playAudio(item.english);
        dragElement = div;
        // Save original position for bounce-back
        dragOrigin = {
          parent: div.parentElement,
          nextSibling: div.nextSibling
        };
        e.dataTransfer.setData('text/plain', JSON.stringify({
          english: item.english,
          japanese: item.japanese
        }));
        setTimeout(() => {
          div.style.visibility = 'hidden';
        }, 0);
      });

      div.addEventListener('dragend', e => {
        div.style.visibility = 'visible';
      });

      return div;
    }

    function createDropTargetJapanese(item) {
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.lang = 'ja';
      div.textContent = item.japanese;
      div.dataset.english = item.english;

      div.addEventListener('dragover', e => {
        e.preventDefault();
        div.style.borderColor = '#00796b';
        div.style.backgroundColor = '#e0f2f1';
      });

      div.addEventListener('dragleave', e => {
        div.style.borderColor = '#00838f';
        div.style.backgroundColor = '#fff';
      });

      div.addEventListener('drop', e => {
        e.preventDefault();
        div.style.borderColor = '#00838f';
        div.style.backgroundColor = '#fff';

        const data = e.dataTransfer.getData('text/plain');
        if (!data) return;
        const dragged = JSON.parse(data);

        if (dragged.japanese === div.textContent) {
          handleCorrectMatch(dragged.english, div);
        } else {
          handleIncorrectMatch(dragged.english);
        }
      });

      return div;
    }

    function handleCorrectMatch(englishWord, japaneseDiv) {
      const engDiv = document.getElementById(`eng-${englishWord.replace(/\s+/g,'-').toLowerCase()}`);
      if (!engDiv || engDiv.classList.contains('correct')) return;

      engDiv.classList.add('correct');
      engDiv.draggable = false;
      engDiv.style.cursor = 'default';

      japaneseDiv.classList.add('correct');
      japaneseDiv.style.pointerEvents = 'none';

      matchedCount++;
      updateProgressBar();

      createSparkleAtElement(engDiv);
      confetti({
        particleCount: 20,
        spread: 70,
        origin: { x: 0.5, y: 0.6 },
      });

      if (matchedCount === totalPairs) {
        endGame(true);
      }
    }

    function createSparkleAtElement(element) {
      const rect = element.getBoundingClientRect();
      const sparkle = document.createElement('div');
      sparkle.className = 'sparkle';
      sparkle.style.position = 'fixed';
      sparkle.style.left = rect.left + rect.width / 2 + 'px';
      sparkle.style.top = rect.top + rect.height / 2 + 'px';
      document.body.appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 800);
    }

    function handleIncorrectMatch(englishWord) {
      const engDiv = document.getElementById(`eng-${englishWord.replace(/\s+/g,'-').toLowerCase()}`);
      if (!engDiv) return;

      // Flash red
      engDiv.classList.add('incorrect-flash');

      // Bounce back animation: remove from drop and append back to original position
      setTimeout(() => {
        engDiv.classList.remove('incorrect-flash');

        // Append back to original position if dragOrigin saved
        if (dragOrigin && dragElement) {
          if (!dragOrigin.nextSibling) {
            dragOrigin.parent.appendChild(dragElement);
          } else {
            dragOrigin.parent.insertBefore(dragElement, dragOrigin.nextSibling);
          }
          dragElement.style.visibility = 'visible';
          dragElement = null;
          dragOrigin = null;
        }
      }, 500);
    }

    function updateProgressBar() {
      const percent = (matchedCount / totalPairs) * 100;
      progressBar.style.width = percent + '%';
    }

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          endGame(false);
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      timerDisplay.textContent = `Time Left: ${min}:${sec.toString().padStart(2,'0')}`;
    }

    function endGame(won) {
      clearInterval(timerInterval);
      let msg = '';
      if (won) {
        msg = 'ðŸŽ‰ Congratulations! You matched all words!';
      } else {
        msg = 'â° Time is up! Try again.';
      }
      showModal(msg);
    }

    function resetGame() {
      clearInterval(timerInterval);
      matchedCount = 0;
      progressBar.style.width = '0%';
      timerDisplay.textContent = 'Time Left: 5:00';
      timerDisplay.classList.add('hidden');
      progressContainer.classList.add('hidden');
      gameScreen.classList.add('hidden');
      startScreen.classList.remove('hidden');
      englishCol1.innerHTML = '';
      englishCol2.innerHTML = '';
      japaneseCol1.innerHTML = '';
      japaneseCol2.innerHTML = '';
    }

    function showModal(message) {
      modalMessage.textContent = message;
      modalOverlay.classList.add('show');
    }
    function closeModal() {
      modalOverlay.classList.remove('show');
    }

    // Speech synthesis for English pronunciation
    function playAudio(text) {
      if (!window.speechSynthesis) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      window.speechSynthesis.cancel(); // stop any current
      window.speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
