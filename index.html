<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vocabulary Match Game</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap"
    rel="stylesheet"
  />
  <style>
    /* ===== Body and base styles ===== */
    body {
      font-family: 'Comic Neue', cursive;
      margin: 0;
      padding: 0;
      background: #fefefe;
      color: #333;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
    }
    body.dark {
      background: #121212;
      color: #ddd;
    }

    /* ===== Start Menu Styling ===== */
    #start-menu {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px 20px;
      gap: 15px;
      box-sizing: border-box;
      background: #fff;
      transition: background-color 0.3s, color 0.3s;
    }
    #start-menu.dark {
      background: #121212;
      color: #ddd;
    }
    .title {
      font-size: 2.5em;
      margin: 0 0 12px;
      text-align: center;
      color: inherit;
      user-select: text;
    }
    #start-menu p {
      max-width: 360px;
      margin: 0 auto 20px;
      font-size: 1.2em;
      color: #555;
    }
    body.dark #start-menu p {
      color: #bbb;
    }

    #lesson-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 14px;
      width: 100%;
      max-width: 640px;
    }
    #lesson-buttons button {
      padding: 14px 0;
      font-size: 1.15em;
      font-weight: 600;
      border-radius: 10px;
      border: none;
      background-color: #ffcae6;
      color: #880048;
      box-shadow: 0 3px 8px rgba(255, 192, 210, 0.6);
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      user-select: none;
      width: 100%;
      text-align: center;
    }
    #lesson-buttons button:hover,
    #lesson-buttons button:focus-visible {
      background-color: #f993ca;
      outline: none;
      transform: translateY(-3px);
      box-shadow: 0 5px 12px rgba(255, 105, 150, 0.8);
    }
    #lesson-buttons button.dark {
      background-color: #a15b7c;
      color: #eee;
      box-shadow: 0 3px 8px rgba(161, 91, 124, 0.7);
    }
    #lesson-buttons button.dark:hover,
    #lesson-buttons button.dark:focus-visible {
      background-color: #9c5072;
      box-shadow: 0 5px 12px rgba(156, 80, 114, 0.8);
    }

    #extra-buttons {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      width: 100%;
      max-width: 400px;
    }
    #challenge-btn,
    #dark-mode-toggle {
      min-width: 180px;
      font-weight: 700;
      border-radius: 12px;
      border: none;
      background-color: #ff85b7;
      color: white;
      box-shadow: 0 4px 10px rgba(255, 85, 140, 0.7);
      cursor: pointer;
      user-select: none;
      padding: 12px 0;
      font-size: 1.1em;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    #challenge-btn:hover,
    #dark-mode-toggle:hover,
    #challenge-btn:focus-visible,
    #dark-mode-toggle:focus-visible {
      background-color: #ff3b82;
      outline: none;
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(255, 59, 130, 0.9);
    }

    /* ===== Game container and grid ===== */
    #game-container {
      display: none;
      max-width: 900px;
      margin: 20px auto 50px;
      padding: 0 10px;
    }

    #game-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      user-select: none;
    }

    .draggable,
    .droppable {
      background: #f9f9ff;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      font-size: 1.2em;
      text-align: center;
      line-height: 2.2;
      cursor: grab;
      padding: 12px;
      user-select: none;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      border: 2px solid transparent;
    }
    .droppable {
      cursor: default;
      background-color: #f0f0f0;
      min-height: 44px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .matched {
      background-color: #c1f0c1 !important;
      border-color: #4caf50 !important;
      box-shadow: 0 0 12px #4caf50aa !important;
      cursor: default !important;
    }
    .draggable.matched {
      cursor: default !important;
    }
    .draggable:active {
      cursor: grabbing;
    }

    /* Bounce animation for incorrect */
    @keyframes bounce {
      0% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-20px);
      }
      100% {
        transform: translateY(0);
      }
    }
    .bounce {
      animation: bounce 0.4s ease;
    }

    /* Flash red on incorrect */
    @keyframes flashRed {
      0%,
      100% {
        background-color: #f9f9ff;
      }
      50% {
        background-color: #ff4c4c;
      }
    }
    .flash-red {
      animation: flashRed 0.5s ease;
    }

    /* Sparkle effect on correct */
    @keyframes sparkle {
      0% {
        box-shadow: 0 0 0px #ff85b7;
      }
      50% {
        box-shadow: 0 0 10px #ff85b7;
      }
      100% {
        box-shadow: 0 0 0px #ff85b7;
      }
    }
    .sparkle {
      animation: sparkle 0.7s ease;
    }

    /* Progress bar */
    #progress-container {
      width: 90%;
      max-width: 600px;
      height: 14px;
      background: #eee;
      border-radius: 12px;
      margin: 25px auto 10px;
      overflow: hidden;
      display: none;
      box-shadow: inset 0 1px 3px #ccc;
    }
    #progress-bar {
      height: 100%;
      width: 0;
      background: #ff85b7;
      border-radius: 12px;
      transition: width 0.3s ease;
    }

    /* Streak counter */
    #streak-counter {
      text-align: center;
      font-weight: 700;
      font-size: 1.25em;
      color: #ff3b82;
      margin-bottom: 15px;
      display: none;
      user-select: none;
    }

    /* End screen */
    #end-screen {
      display: none;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      background: #ffcae6;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(255, 105, 150, 0.6);
      text-align: center;
      font-size: 1.25em;
      user-select: none;
    }
    #end-screen.dark {
      background: #9c5072;
      color: #fff;
      box-shadow: 0 4px 12px rgba(156, 80, 114, 0.8);
    }
    #end-title {
      font-weight: 700;
      font-size: 1.6em;
      margin-bottom: 8px;
    }
    #end-summary,
    #end-score {
      margin-bottom: 18px;
    }
    #end-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    #end-buttons button {
      background: #ff85b7;
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 700;
      font-size: 1.1em;
      padding: 12px 20px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(255, 85, 140, 0.7);
      transition: background-color 0.3s ease, transform 0.2s ease;
      user-select: none;
      min-width: 140px;
    }
    #end-buttons button:hover,
    #end-buttons button:focus-visible {
      background-color: #ff3b82;
      outline: none;
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(255, 59, 130, 0.9);
    }

    /* Dark mode adjustments for buttons on end screen */
    #end-screen.dark #end-buttons button {
      background-color: #9c5072;
      box-shadow: 0 4px 10px rgba(156, 80, 114, 0.8);
    }
    #end-screen.dark #end-buttons button:hover,
    #end-screen.dark #end-buttons button:focus-visible {
      background-color: #7a3e5b;
      box-shadow: 0 6px 15px rgba(122, 62, 91, 0.9);
    }

    /* Confetti canvas */
    #confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
      width: 100vw;
      height: 100vh;
      z-index: 9999;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Start Menu -->
  <div id="start-menu" role="main" aria-label="Start menu">
    <h1 class="title">Vocabulary Match Game</h1>
    <p>
      Select a lesson to begin. Challenge mode is a timed 2-minute game!
    </p>
    <div id="lesson-buttons" aria-label="Lesson selection" role="list"></div>
    <div id="extra-buttons">
      <button id="challenge-btn" aria-label="Start challenge mode (2 minutes)">
        Challenge Mode üî• (2 min)
      </button>
      <button id="dark-mode-toggle" aria-pressed="false" aria-label="Toggle dark mode">
        üåì Toggle Dark Mode
      </button>
    </div>
  </div>

  <!-- Game Container -->
  <div id="game-container">
    <div id="progress-container" aria-hidden="true">
      <div id="progress-bar"></div>
    </div>
    <div id="streak-counter" aria-live="polite" aria-atomic="true"></div>
    <div id="game-grid" role="grid" aria-label="Matching game grid"></div>
  </div>

  <!-- End Screen -->
  <div id="end-screen" role="region" aria-live="polite" aria-atomic="true">
    <div id="end-title"></div>
    <div id="end-summary"></div>
    <div id="end-score"></div>
    <div id="end-buttons">
      <button id="restart-btn">Play Again</button>
      <button id="back-to-menu-btn">Back to Menu</button>
    </div>
  </div>

  <!-- Confetti canvas -->
  <canvas id="confetti-canvas"></canvas>

  <script>
    (() => {
      const lessons = [
        {
          name: "Lesson 1",
          words: [
            { english: "minute", japanese: "ÂàÜ" },
            { english: "before", japanese: "„ÅÆÂâç„Å´" },
            { english: "photography", japanese: "ÂÜôÁúüÊíÆÂΩ±" },
            { english: "tournament", japanese: "„Éà„Éº„Éä„É°„É≥„Éà" },
            { english: "against", japanese: "„Å´ÂØæÊäó„Åó„Å¶" },
            { english: "lost", japanese: "Ë≤†„Åë„Å£„Åü" },
            { english: "lose", japanese: "Ë≤†„Åë„Çã" },
            { english: "final", japanese: "ÊúÄÂæå„ÅÆ" },
            { english: "second", japanese: "Áßí" },
            { english: "broke", japanese: "Â£ä„Åó„Åü" },
            { english: "surely", japanese: "Á¢∫„Åã„Å´" },
            { english: "until", japanese: "„ÄÇ„ÄÇ„ÄÇ„Åæ„Åß" },
            { english: "half", japanese: "ÂçäÂàÜ„ÅÆ" },
            { english: "hour", japanese: "ÔºëÊôÇÈñì" },
            { english: "tomorrow", japanese: "ÊòéÊó•" },
            { english: "today", japanese: "‰ªäÊó•" },
            { english: "yesterday", japanese: "Êò®Êó•" },
            { english: "ago", japanese: "ÔΩûÂâç„Å´" },
            { english: "spread", japanese: "Â∫É„ÇÅ„Çã" },
            { english: "stadium", japanese: "„Çπ„Çø„Ç∏„Ç¢„É†" }
          ]
        },
        {
          name: "Lesson 2",
          words: [
            { english: "delicious", japanese: "„Åä„ÅÑ„Åó„ÅÑ" },
            { english: "happy", japanese: "Âπ∏„Åõ" },
            { english: "run", japanese: "Ëµ∞„Çã" },
            { english: "draw", japanese: "Êèè„Åè" },
            { english: "build", japanese: "Âª∫„Å¶„Çã" },
            { english: "carry", japanese: "ÈÅã„Å∂" },
            { english: "open", japanese: "Èñã„Åë„Çã" },
            { english: "close", japanese: "Èñâ„Åò„Çã" },
            { english: "wake up", japanese: "ÁõÆ„ÇíË¶ö„Åæ„Åô" },
            { english: "sleep", japanese: "Áú†„Çã" },
            { english: "stand", japanese: "Á´ã„Å§" },
            { english: "sit", japanese: "Â∫ß„Çã" },
            { english: "jump", japanese: "Ë∑≥„Å∂" },
            { english: "swim", japanese: "Ê≥≥„Åê" },
            { english: "drive", japanese: "ÈÅãËª¢„Åô„Çã" },
            { english: "listen", japanese: "ËÅû„Åè" },
            { english: "write", japanese: "Êõ∏„Åè" },
            { english: "read", japanese: "Ë™≠„ÇÄ" },
            { english: "speak", japanese: "Ë©±„Åô" },
            { english: "learn", japanese: "Â≠¶„Å∂" }
          ]
        },
        // You can add lessons 3 - 14 here similarly
      ];

      // DOM Elements
      const startMenu = document.getElementById("start-menu");
      const lessonButtons = document.getElementById("lesson-buttons");
      const challengeBtn = document.getElementById("challenge-btn");
      const darkModeToggle = document.getElementById("dark-mode-toggle");
      const gameContainer = document.getElementById("game-container");
      const gameGrid = document.getElementById("game-grid");
      const progressContainer = document.getElementById("progress-container");
      const progressBar = document.getElementById("progress-bar");
      const streakCounter = document.getElementById("streak-counter");
      const endScreen = document.getElementById("end-screen");
      const endTitle = document.getElementById("end-title");
      const endSummary = document.getElementById("end-summary");
      const endScore = document.getElementById("end-score");
      const restartBtn = document.getElementById("restart-btn");
      const backToMenuBtn = document.getElementById("back-to-menu-btn");
      const confettiCanvas = document.getElementById("confetti-canvas");
      const ctx = confettiCanvas.getContext("2d");

      let currentLessonIndex = 0;
      let words = [];
      let matchedPairs = 0;
      let draggedElement = null;
      let streak = 0;
      let maxStreak = 0;
      let challengeMode = false;
      let challengeTimer = null;
      let timeLeft = 0;
      let confettiParticles = [];

      // Setup lesson buttons on start screen
      function setupLessonButtons() {
        lessonButtons.innerHTML = "";
        lessons.forEach((lesson, i) => {
          const btn = document.createElement("button");
          btn.textContent = lesson.name;
          btn.setAttribute("role", "listitem");
          btn.onclick = () => startGame(i, false);
          lessonButtons.appendChild(btn);
        });
      }

      // Start game with lesson index and mode (challenge or not)
      function startGame(index, isChallenge = false) {
        currentLessonIndex = index;
        challengeMode = isChallenge;
        words = lessons[index].words;
        matchedPairs = 0;
        streak = 0;
        maxStreak = 0;

        // UI changes
        startMenu.style.display = "none";
        endScreen.style.display = "none";
        gameContainer.style.display = "block";

        progressContainer.style.display = challengeMode ? "block" : "none";
        streakCounter.style.display = challengeMode ? "block" : "none";

        progressBar.style.width = "0%";
        streakCounter.textContent = "";

        setupGrid();

        if (challengeMode) {
          startChallengeTimer(120); // 2 minutes
        } else {
          stopChallengeTimer();
        }
      }

      // Setup grid with English on left 2 columns, Japanese on right 2 columns
      function setupGrid() {
        gameGrid.innerHTML = "";
        const shuffledEnglish = [...words].sort(() => Math.random() - 0.5);
        const shuffledJapanese = [...words].sort(() => Math.random() - 0.5);

        // Create English draggable divs in first two columns
        shuffledEnglish.forEach((pair) => {
          const engDiv = document.createElement("div");
          engDiv.className = "draggable";
          engDiv.textContent = pair.english;
          engDiv.dataset.word = pair.english;
          engDiv.setAttribute("draggable", "true");
          engDiv.setAttribute("aria-grabbed", "false");
          engDiv.tabIndex = 0;
          engDiv.addEventListener("dragstart", dragStart);
          engDiv.addEventListener("dragend", dragEnd);
          engDiv.addEventListener("touchstart", handleTouchStart, {
            passive: false,
          });
          gameGrid.appendChild(engDiv);
        });

        // Create Japanese droppable divs in last two columns
        shuffledJapanese.forEach((pair) => {
          const japDiv = document.createElement("div");
          japDiv.className = "droppable";
          japDiv.textContent = pair.japanese;
          japDiv.dataset.match = pair.english;
          japDiv.tabIndex = 0;
          japDiv.addEventListener("dragover", (e) => e.preventDefault());
          japDiv.addEventListener("drop", handleDrop);
          gameGrid.appendChild(japDiv);
        });

        // Adjust grid to 4 columns: first 2 for English, last 2 for Japanese
        gameGrid.style.gridTemplateColumns = "repeat(4, 1fr)";
      }

      // Drag & Drop handlers
      function dragStart(e) {
        draggedElement = e.target;
        draggedElement.setAttribute("aria-grabbed", "true");
        e.dataTransfer?.setData("text/plain", draggedElement.dataset.word);
        setTimeout(() => draggedElement.classList.add("hide"), 0);
      }
      function dragEnd(e) {
        if (!draggedElement) return;
        draggedElement.classList.remove("hide");
        draggedElement.setAttribute("aria-grabbed", "false");
        draggedElement = null;
      }
      function handleDrop(e) {
        e.preventDefault();
        const dropTarget = e.target.closest(".droppable");
        if (!dropTarget || !draggedElement) return;
        const draggedWord = draggedElement.dataset.word;
        if (dropTarget.dataset.match === draggedWord) {
          onCorrectMatch(dropTarget, draggedElement);
        } else {
          onIncorrectMatch(draggedElement);
        }
      }

      // Touch handlers for drag-drop
      function handleTouchStart(e) {
        e.preventDefault();
        draggedElement = e.target;
        draggedElement.setAttribute("aria-grabbed", "true");
        draggedElement.style.position = "absolute";
        draggedElement.style.zIndex = "1000";
        draggedElement.initialX = e.touches[0].clientX - draggedElement.getBoundingClientRect().left;
        draggedElement.initialY = e.touches[0].clientY - draggedElement.getBoundingClientRect().top;
        document.addEventListener("touchmove", handleTouchMove, { passive: false });
        document.addEventListener("touchend", handleTouchEnd);
      }
      function handleTouchMove(e) {
        e.preventDefault();
        const touch = e.touches[0];
        draggedElement.style.left = `${touch.clientX - draggedElement.initialX}px`;
        draggedElement.style.top = `${touch.clientY - draggedElement.initialY}px`;
      }
      function handleTouchEnd(e) {
        e.preventDefault();
        const touch = e.changedTouches[0];
        const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
        if (dropTarget && dropTarget.classList.contains("droppable")) {
          if (dropTarget.dataset.match === draggedElement.dataset.word) {
            onCorrectMatch(dropTarget, draggedElement);
          } else {
            onIncorrectMatch(draggedElement);
            resetDraggedPosition();
          }
        } else {
          onIncorrectMatch(draggedElement);
          resetDraggedPosition();
        }
        draggedElement.style.position = "";
        draggedElement.style.zIndex = "";
        draggedElement.style.left = "";
        draggedElement.style.top = "";
        draggedElement.setAttribute("aria-grabbed", "false");
        draggedElement = null;
        document.removeEventListener("touchmove", handleTouchMove);
        document.removeEventListener("touchend", handleTouchEnd);
      }
      function resetDraggedPosition() {
        if (!draggedElement) return;
        draggedElement.style.transition = "transform 0.4s ease";
        draggedElement.style.transform = "translateY(-20px)";
        setTimeout(() => {
          draggedElement.style.transform = "translateY(0)";
          setTimeout(() => {
            draggedElement.style.transition = "";
          }, 300);
        }, 200);
      }

      // Handle correct match
      function onCorrectMatch(dropTarget, draggedEl) {
        dropTarget.classList.add("matched", "sparkle");
        draggedEl.classList.add("matched", "sparkle");
        dropTarget.textContent = "";
        dropTarget.appendChild(draggedEl);
        draggedEl.setAttribute("draggable", "false");
        draggedEl.style.cursor = "default";

        matchedPairs++;
        streak++;
        if (streak > maxStreak) maxStreak = streak;

        // Show streak if 3 or more
        if (streak >= 3) {
          streakCounter.textContent = `üî• Streak: ${streak} üî•`;
          streakCounter.classList.add("sparkle");
          setTimeout(() => streakCounter.classList.remove("sparkle"), 800);
        } else {
          streakCounter.textContent = "";
        }

        updateProgress();

        // Play correct audio
        playWordAudio(draggedEl.dataset.word);

        if (matchedPairs === words.length) {
          // Game complete
          showConfetti();
          setTimeout(() => {
            showEndScreen();
          }, 1400);
        }
      }

      // Handle incorrect match
      function onIncorrectMatch(draggedEl) {
        streak = 0;
        streakCounter.textContent = "";
        // Flash red effect
        draggedEl.classList.add("flash-red");
        setTimeout(() => draggedEl.classList.remove("flash-red"), 600);

        resetDraggedPosition();
        // Optionally play error sound here
      }

      // Progress update
      function updateProgress() {
        if (!challengeMode) return;
        const progressPercent = (matchedPairs / words.length) * 100;
        progressBar.style.width = `${progressPercent}%`;
      }

      // Challenge timer
      function startChallengeTimer(seconds) {
        timeLeft = seconds;
        progressContainer.style.display = "block";
        streakCounter.style.display = "block";
        updateTimerUI();

        if (challengeTimer) clearInterval(challengeTimer);
        challengeTimer = setInterval(() => {
          timeLeft--;
          updateTimerUI();
          if (timeLeft <= 0) {
            clearInterval(challengeTimer);
            showEndScreen(true); // time over
          }
        }, 1000);
      }
      function stopChallengeTimer() {
        if (challengeTimer) clearInterval(challengeTimer);
        progressContainer.style.display = "none";
        streakCounter.style.display = "none";
        progressBar.style.width = "0%";
      }
      function updateTimerUI() {
        const progressPercent = ((120 - timeLeft) / 120) * 100;
        progressBar.style.width = `${progressPercent}%`;
      }

      // Show end screen
      function showEndScreen(timeOver = false) {
        gameContainer.style.display = "none";
        endScreen.style.display = "block";
        endScreen.classList.toggle("dark", document.body.classList.contains("dark"));
        if (timeOver) {
          endTitle.textContent = "Time's up!";
          endSummary.textContent = `You matched ${matchedPairs} out of ${words.length} words.`;
        } else {
          endTitle.textContent = "Well done!";
          endSummary.textContent = `You matched all ${words.length} words!`;
        }
        endScore.textContent = `Longest Streak: ${maxStreak}`;
      }

      // Restart & Back to Menu buttons
      restartBtn.onclick = () => {
        startGame(currentLessonIndex, challengeMode);
        endScreen.style.display = "none";
      };
      backToMenuBtn.onclick = () => {
        endScreen.style.display = "none";
        gameContainer.style.display = "none";
        startMenu.style.display = "flex";
      };

      // Dark mode toggle
      darkModeToggle.onclick = () => {
        document.body.classList.toggle("dark");
        startMenu.classList.toggle("dark");
        endScreen.classList.toggle("dark");
        // Update button aria-pressed
        const pressed = darkModeToggle.getAttribute("aria-pressed") === "true";
        darkModeToggle.setAttribute("aria-pressed", !pressed);
        // Update lesson buttons styles for dark mode
        [...lessonButtons.children].forEach((btn) =>
          btn.classList.toggle("dark")
        );
      };

      // Challenge mode button
      challengeBtn.onclick = () => {
        startGame(0, true);
      };

      // Play word audio using speech synthesis AI voice
      function playWordAudio(word) {
        if (!window.speechSynthesis) return;
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = "en-US";
        utterance.rate = 0.9;
        utterance.pitch = 1;
        window.speechSynthesis.cancel(); // Cancel any previous
        window.speechSynthesis.speak(utterance);
      }

      // Confetti effect
      function showConfetti() {
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
        confettiCanvas.style.display = "block";

        confettiParticles = [];
        const colors = ["#ff85b7", "#ffcae6", "#f993ca", "#ff3b82"];
        const count = 150;

        for (let i = 0; i < count; i++) {
          confettiParticles.push({
            x: Math.random() * confettiCanvas.width,
            y: Math.random() * confettiCanvas.height - confettiCanvas.height,
            r: Math.random() * 6 + 4,
            d: Math.random() * count,
            color: colors[Math.floor(Math.random() * colors.length)],
            tilt: Math.random() * 10 - 10,
            tiltAngle: 0,
            tiltAngleIncrement: Math.random() * 0.1 + 0.05,
          });
        }

        function draw() {
          ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
          confettiParticles.forEach((p) => {
            ctx.beginPath();
            ctx.lineWidth = p.r / 2;
            ctx.strokeStyle = p.color;
            ctx.moveTo(p.x + p.tilt + p.r / 3, p.y);
            ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r / 3);
            ctx.stroke();
          });
          update();
        }
        function update() {
          confettiParticles.forEach((p, i) => {
            p.tiltAngle += p.tiltAngleIncrement;
            p.y += (Math.cos(p.d) + 3 + p.r / 2) / 2;
            p.x += Math.sin(p.d);
            p.tilt = Math.sin(p.tiltAngle) * 12;

            if (p.y > confettiCanvas.height) {
              confettiParticles[i] = {
                x: Math.random() * confettiCanvas.width,
                y: -20,
                r: p.r,
                d: p.d,
                color: p.color,
                tilt: p.tilt,
                tiltAngle: p.tiltAngle,
                tiltAngleIncrement: p.tiltAngleIncrement,
              };
            }
          });
        }

        let confettiAnimation = null;
        function runConfetti() {
          draw();
          confettiAnimation = requestAnimationFrame(runConfetti);
        }
        runConfetti();

        setTimeout(() => {
          cancelAnimationFrame(confettiAnimation);
          confettiCanvas.style.display = "none";
        }, 4000);
      }

      // Initialization
      setupLessonButtons();
    })();
  </script>
</body>
</html>
